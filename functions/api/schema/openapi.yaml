openapi: 3.1.0
info:
  title: OpenPecha API v2
  version: "2.1.0"
servers:
  - url: http://127.0.0.1:5001/pecha-backend-test-3a4d0/us-central1/api
    description: Local Development
  - url: https://api-kwgjscy6gq-uc.a.run.app
    description: Test
  - url: https://api-l25bgmwqoa-uc.a.run.app
    description: Development
  - url: https://api-aq25662yyq-uc.a.run.app
    description: Production

paths:
  /v2/editions/{edition_id}:
    get:
      summary: Retrieve edition by edition ID
      description: Fetch edition content for a given edition ID. Optionally include non-alignment annotations using the 'annotation' query parameter.
      tags:
        - Editions
      parameters:
        - name: edition_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the edition to retrieve
        - name: annotation
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Whether to include annotations (alignment annotations are excluded)
        - name: content
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Whether to include content (base text)
      responses:
        "200":
          description: Edition retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
                  metadata:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        enum: [diplomatic, critical]
                      source:
                        type: string
                        nullable: true
                      bdrc:
                        type: string
                      wiki:
                        type: string
                      colophon:
                        type: string
                      incipit_title:
                        type: object
                        additionalProperties:
                          type: string
                      alt_incipit_titles:
                        type: array
                        items:
                          type: object
                          additionalProperties:
                            type: string
                  annotations:
                    type: array
                    items:
                      type: object
                      properties:
                        annotation_id:
                          type: string
                        type:
                          type: string
                          enum: [segmentation, version]
              examples:
                with_annotations_no_content:
                  summary: Instance with metadata, annotation without content
                  value:
                    metadata:
                      id: "I12345678"
                      type: "critical"
                      source: "source-name"
                      bdrc: "W123456"
                      wiki: "Q123456"
                      colophon: "colophon text"
                      incipit_title:
                        en: "English incipit title"
                        bo: "Tibetan incipit title"
                      alt_incipit_titles:
                        - en: "Alt title 1"
                        - bo: "Alt title 2"
                    annotations:
                      - annotation_id: "A12345678"
                        type: "segmentation"
                with_content_no_annotations:
                  summary: Instance with metadata, content without annotations
                  value:
                    content: "This is the base text content"
                    metadata:
                      id: "I12345678"
                      type: "critical"
                      source: "source-name"
                      bdrc: "W123456"
                      wiki: "Q123456"
                      colophon: "colophon text"
                      incipit_title:
                        en: "English incipit title"
                        bo: "Tibetan incipit title"
                      alt_incipit_titles:
                        - en: "Alt title 1"
                        - bo: "Alt title 2"
                with_content_and_annotations:
                  summary: Instance with metadata, annotations and content
                  value:
                    content: "This is the base text content"
                    metadata:
                      id: "I12345678"
                      type: "critical"
                      source: "source-name"
                      bdrc: "W123456"
                      wiki: "Q123456"
                      colophon: "colophon text"
                      incipit_title:
                        en: "English incipit title"
                        bo: "Tibetan incipit title"
                      alt_incipit_titles:
                        - en: "Alt title 1"
                        - bo: "Alt title 2"
                    annotations:
                      - annotation_id: "A12345678"
                        type: "segmentation"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
    put:
      summary: Update an existing edition
      description: >-
        Update an existing edition (manifestation) with new metadata, content, and annotations.
        This operation replaces all existing annotations and content for the manifestation.
        All old annotations (segmentation, pagination, bibliography, etc.) will be deleted and replaced with the new ones provided.
      tags:
        - Editions
      parameters:
        - name: edition_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the edition to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - metadata
                - content
              properties:
                metadata:
                  type: object
                  required:
                    - type
                    - source
                  properties:
                    type:
                      type: string
                      enum: [diplomatic, critical]
                      description: Type of manifestation
                    source:
                      type: string
                      nullable: true
                      description: Source identifier for the manifestation
                    bdrc:
                      type: string
                      description: BDRC identifier
                    wiki:
                      type: string
                      description: Wiki identifier
                    colophon:
                      type: string
                      description: Colophon text
                    incipit_title:
                      type: object
                      additionalProperties:
                        type: string
                      description: Localized incipit title
                    alt_incipit_titles:
                      type: array
                      items:
                        type: object
                        additionalProperties:
                          type: string
                      description: Alternative localized incipit titles
                annotation:
                  type: array
                  items:
                    oneOf:
                      - type: object
                        required: [span]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                        description: Segmentation annotation (for CRITICAL manifestations)
                      - type: object
                        required: [span, reference]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                          reference:
                            type: string
                            description: Page/folio reference for the span
                        description: Pagination annotation (for DIPLOMATIC manifestations)
                  description: Segmentation or pagination annotation segments
                biblography_annotation:
                  type: array
                  items:
                    type: object
                    required: [span, type]
                    properties:
                      span:
                        type: object
                        required: [start, end]
                        properties:
                          start:
                            type: integer
                            minimum: 0
                            description: Start character position (inclusive)
                          end:
                            type: integer
                            minimum: 1
                            description: End character position (exclusive)
                      type:
                        type: string
                        enum: [colophon, title, incipit_title, author]
                        description: Type of bibliography annotation
                  description: Bibliography annotation segments with bibliography type
                content:
                  type: string
                  description: The updated text content
            examples:
              update_critical_instance:
                summary: Update a critical instance with new segmentation
                value:
                  metadata:
                    type: "critical"
                    source: "updated-source"
                    colophon: "Updated colophon text"
                    incipit_title:
                      en: "Updated Opening words"
                      bo: "དབུ་ཚིག་གསར་བ།"
                  annotation:
                    - span:
                        start: 0
                        end: 15
                    - span:
                        start: 15
                        end: 30
                  content: "This is the updated text content"
              update_diplomatic_instance:
                summary: Update a diplomatic instance with pagination
                value:
                  metadata:
                    type: "diplomatic"
                    source: "updated-source"
                    bdrc: "W123456"
                    colophon: "Updated colophon"
                  annotation:
                    - span:
                        start: 0
                        end: 10
                      reference: "https://example.com/updated-image1.png"
                    - span:
                        start: 10
                        end: 20
                      reference: "https://example.com/updated-image2.png"
                  content: "Updated text content for diplomatic instance"
              update_with_bibliography:
                summary: Update instance with bibliography annotation
                value:
                  metadata:
                    type: "critical"
                    source: "source-name"
                  annotation:
                    - span:
                        start: 0
                        end: 50
                  biblography_annotation:
                    - span:
                        start: 0
                        end: 20
                      type: "title"
                    - span:
                        start: 21
                        end: 35
                      type: "author"
                  content: "Updated content with bibliography information"
      responses:
        "200":
          description: Instance updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Manifestation updated successfully"
                  id:
                    type: string
                    description: The ID of the updated manifestation
                    example: "I12345678"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
    delete:
      summary: Delete an edition
      description: >-
        Delete an edition (manifestation) and all its associated data including
        annotations (segmentation, pagination, bibliography, durchen notes, alignments)
        and stored content.
      tags:
        - Editions
      parameters:
        - name: edition_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the edition to delete
      responses:
        "200":
          description: Edition deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Edition deleted successfully"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
  /v2/editions/{edition_id}/related:
    get:
      summary: Find related editions
      description: >-
        Find all manifestations with alignment relationships to the given edition.
        Works bidirectionally: returns translations/commentaries for root texts, or root texts for translations/commentaries.
        Optionally filter by relationship type (translation/commentary).
      tags:
        - Editions
      parameters:
        - name: edition_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the edition to find related editions for
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [translation, commentary, root]
          description: Optional filter to only return editions of a specific relationship type
      responses:
        "200":
          description: Related editions retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    edition_id:
                      type: string
                      description: The ID of the related manifestation
                    metadata:
                      type: object
                      description: Essential manifestation and expression metadata
                      properties:
                        edition_type:
                          type: string
                          enum: [diplomatic, critical]
                          description: Instance type
                        source:
                          type: string
                          description: Source of the manifestation
                        text_id:
                          type: string
                          description: Text ID
                        title:
                          type: object
                          description: Expression title in localized format
                        alt_titles:
                          type: array
                          items:
                            type: object
                          description: Alternative titles
                        language:
                          type: string
                          description: Language code
                        contributions:
                          type: array
                          items:
                            type: object
                            properties:
                              person_id:
                                type: string
                                description: Person identifier (for person contributions)
                              ai_id:
                                type: string
                                description: AI identifier (for AI contributions)
                              role:
                                type: string
                                enum: [translator, reviser, author, scholar]
                                description: Contributor role
                          description: Contributors list
                    annotation:
                      type: string
                      description: The alignment annotation ID (from the source manifestation with aligned_to set)
                    relationship:
                      type: string
                      enum: [translation, commentary, root]
                      description: The type of relationship between the editions
              examples:
                translation_example:
                  summary: Translation of a root text
                  value:
                    - edition_id: "I87654321"
                      metadata:
                        edition_type: "critical"
                        source: "source-name"
                        text_id: "E12345678"
                        title:
                          en: "Heart Sutra - English Translation"
                          bo: "ཤེས་རབ་སྙིང་པོ་དབྱིན་སྐད།"
                        alt_titles:
                          - en: "Prajnaparamita Heart Sutra"
                        language: "en"
                        contributions:
                          - person_id: "P12345678"
                            role: "translator"
                          - person_id: "P87654321"
                            role: "reviser"
                      annotation: "A98765432"
                      relationship: "translation"
                    - edition_id: "I87654322"
                      metadata:
                        edition_type: "critical"
                        source: "source-name"
                        text_id: "E12345679"
                        title:
                          zh: "心经 - 中文翻译"
                        alt_titles: []
                        language: "zh"
                        contributions:
                          - person_id: "P23456789"
                            role: "translator"
                      annotation: "A98765433"
                      relationship: "translation"
                ai_contribution_example:
                  summary: AI-generated translation
                  value:
                    - edition_id: "I87654323"
                      metadata:
                        edition_type: "critical"
                        source: "source-name"

                        text_id: "E12345680"
                        title:
                          en: "AI Generated Translation"
                        alt_titles: []
                        language: "en"
                        contributions:
                          - ai_id: "gpt-4"
                            role: "translator"
                      annotation: "A98765434"
                      relationship: "translation"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/editions/{edition_id}/segment-related:
    get:
      summary: Find related segments or spans for an edition
      description: >-
        Exactly one of `segment_id` or (`span_start` and `span_end`) must be provided.
        - If `segment_id` is provided, returns related segments across manifestations.
        - If `span_start` and `span_end` are provided, returns manifestations with merged spans overlapping the given range.
        - If both are provided, `segment_id` takes precedence.
      tags:
        - Editions
      parameters:
        - name: edition_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the edition to search within (used when querying by span)
        - name: segment_id
          in: query
          required: false
          schema:
            type: string
          description: Segment ID to find related segments across other manifestations
        - name: span_start
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Inclusive start offset when searching by span
        - name: span_end
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: Exclusive end offset (must be greater than span_start)
        - name: transform
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Whether to transfer alignments to segmentation layer. If false (default), returns alignment annotation segments. If true, returns segmentation annotation segments.
      responses:
        "200":
          description: Related items retrieved successfully
          content:
            application/json:
              schema:
                type: array
                description: List of related manifestations with their segments. Same format for both transfer modes - only segment source differs (alignment vs segmentation annotation).
                items:
                  type: object
                  required: [text, instance, segments]
                  properties:
                    text:
                      type: object
                      description: Expression (text) metadata
                      additionalProperties: true
                    instance:
                      type: object
                      description: Manifestation (instance) metadata
                      additionalProperties: true
                    segments:
                      type: array
                      description: Segments from alignment annotation (transfer=false) or segmentation annotation (transfer=true)
                      items:
                        type: object
                        required: [id, span]
                        properties:
                          id:
                            type: string
                            description: Segment ID
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Inclusive start offset
                              end:
                                type: integer
                                minimum: 1
                                description: Exclusive end offset
              examples:
                untransform:
                  summary: Related segments without transfer (alignment annotation)
                  value:
                    - text:
                        id: "E123"
                        type: "translation"
                        language: "en"
                        title: { en: "English Translation" }
                      instance:
                        id: "I456"
                        type: "critical"
                        source: "source-name"
                      segments:
                        - id: "SEG789"
                          span: { start: 50, end: 90 }
                        - id: "SEG790"
                          span: { start: 90, end: 120 }
                transform:
                  summary: Related segments with transfer (segmentation annotation)
                  value:
                    - text:
                        id: "E123"
                        type: "translation"
                        language: "en"
                        title: { en: "English Translation" }
                      instance:
                        id: "I456"
                        type: "critical"
                        source: "source-name"
                      segments:
                        - id: "SEG_S101"
                          span: { start: 50, end: 75 }
                        - id: "SEG_S102"
                          span: { start: 75, end: 100 }
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                missing_params:
                  summary: Neither segment_id nor span provided
                  value:
                    error: "No segment ID or span provided"
                segment_mismatch:
                  summary: Segment does not belong to manifestation
                  value:
                    error: "Segment SEG123 does not belong to manifestation M456"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                no_segments:
                  summary: No segments found for span
                  value:
                    error: "No segments found containing span [0, 100) in instance 'I12345678'"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                span_minimum:
                  summary: Invalid span values
                  value:
                    error: "Input should be greater than or equal to 0"
                invalid_span_type:
                  summary: Invalid span type in SegmentModel
                  value:
                    error: "Input should be a valid dictionary or instance of SpanModel"
        "500":
          $ref: "#/components/responses/ServerError"

  # /v2/editions/{edition_id}/related:

  /v2/editions/{edition_id}/segment-content:
    post:
      summary: Get text content from segments or span
      description: |
        Unified endpoint to get text content from either:
        1. Multiple segments (using segment_ids in request body)
        2. An instance excerpt (using span_start and span_end)

        **Validation constraints:**
        - If segment_ids is provided: cannot use span_start or span_end parameters
        - If using span approach: must provide span_start and span_end, cannot use segment_ids
        - Must provide either segment_ids OR span_start and span_end (mutually exclusive)
      tags:
        - Editions
      parameters:
        - name: edition_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the edition to retrieve content from
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                segment_ids:
                  type: array
                  items:
                    type: string
                  description: List of segment IDs to retrieve content for (alternative to span)
                  example: ["SEG001", "SEG002", "SEG003"]
                span_start:
                  type: integer
                  minimum: 0
                  description: Start position for span-based excerpt (alternative to segment_ids)
                span_end:
                  type: integer
                  minimum: 1
                  description: End position for span-based excerpt (alternative to segment_ids)
            examples:
              multiple_segments:
                summary: Fetch content for multiple segments
                value:
                  segment_ids: ["SEG001", "SEG002", "SEG003"]
              span_excerpt:
                summary: Fetch content by span range
                value:
                  span_start: 0
                  span_end: 100
      responses:
        "200":
          description: Text content retrieved successfully
          content:
            application/json:
              schema:
                type: array
                description: List of segment content dictionaries
                items:
                  type: object
                  properties:
                    segment_id:
                      type: string
                      nullable: true
                      description: Segment ID (null for span-based content)
                    content:
                      type: string
                      description: The extracted text content
                  required:
                    - segment_id
                    - content
              examples:
                segment_content:
                  summary: Content retrieved by single segment ID
                  value:
                    - segment_id: "SEG001"
                      content: "This is the text content of the segment."
                multiple_segments_content:
                  summary: Content retrieved by multiple segment IDs
                  value:
                    - segment_id: "SEG001"
                      content: "This is the first segment content."
                    - segment_id: "SEG002"
                      content: "This is the second segment content."
                    - segment_id: "SEG003"
                      content: "This is the third segment content."
                manifestation_excerpt:
                  summary: Content retrieved by manifestation span
                  value:
                    - segment_id: null
                      content: "This is the text content from the specified span."
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Error message
              examples:
                missing_parameters:
                  summary: Neither segment_ids nor span parameters provided
                  value:
                    error: "Either segment_ids OR span_start and span_end is required"
                conflicting_parameters:
                  summary: Both segment_ids and span parameters provided
                  value:
                    error: "Cannot provide both segment_ids and span parameters. Use one approach only."
                invalid_segment_ids_type:
                  summary: segment_ids is not a list
                  value:
                    error: "segment_ids must be a list"
                missing_body:
                  summary: Request body is missing
                  value:
                    error: "Request body is required"
                missing_span:
                  summary: Missing span parameters for span approach
                  value:
                    error: "span_start and span_end parameters are required when using span approach"
                invalid_span:
                  summary: Invalid span parameters (handled by SpanModel)
                  value:
                    error: "Invalid span parameters: 'start' must be less than 'end'"
                segment_span_exceeds:
                  summary: Segment span exceeds text length
                  value:
                    error: "segment span end (1000) exceeds base text length (500)"
                instance_span_exceeds:
                  summary: Instance span exceeds text length
                  value:
                    error: "span end (1000) exceeds base text length (500)"
        "404":
          description: Resource not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Error message
              examples:
                segment_not_found:
                  summary: Segment not found
                  value:
                    error: "Failed to retrieve segment content: Segment with ID 'SEG123' not found"
                instance_not_found:
                  summary: Instance not found
                  value:
                    error: "Failed to retrieve instance content: Instance with ID 'INST123' not found"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/texts/{text_id}/instances:
    get:
      summary: Get instances for text
      description: Retrieve all instances associated with a text. Optionally filter by instance type (manifestation type).
      tags:
        - Editions
      parameters:
        - name: text_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the text
        - name: edition_type
          in: query
          required: false
          schema:
            type: string
            enum: [diplomatic, critical, all]
            default: all
          description: Filter instances by type. Use 'diplomatic' for diplomatic editions, 'critical' for critical editions, or 'all' to retrieve all types (default).
      responses:
        "200":
          description: Instances retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    type:
                      type: string
                      enum: [diplomatic, critical]
                    source:
                      type: string
                      nullable: true
                    bdrc:
                      type: string
                    wiki:
                      type: string
                    colophon:
                      type: string
                    incipit_title:
                      type: object
                      additionalProperties:
                        type: string
                    alt_incipit_titles:
                      type: array
                      items:
                        type: object
                        additionalProperties:
                          type: string
              examples:
                success:
                  summary: List of instances
                  value:
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "diplomatic"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "diplomatic"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "diplomatic"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "diplomatic"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "critical"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      incipit_title: null
                      type: "diplomatic"
                      wiki: null
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

    post:
      summary: Create a new edition
      description: Create a new edition with metadata for a specific text
      tags:
        - Editions
      parameters:
        - name: text_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the text to create an edition for
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - metadata
                - content
              properties:
                metadata:
                  type: object
                  required:
                    - type
                    - source
                  properties:
                    type:
                      type: string
                      enum: [diplomatic, critical]
                      description: Type of manifestation
                    source:
                      type: string
                      nullable: true
                      description: Source identifier for the manifestation
                    bdrc:
                      type: string
                      description: BDRC identifier (required for diplomatic type)
                    wiki:
                      type: string
                      description: Wiki identifier
                    colophon:
                      type: string
                      description: Colophon text
                    incipit_title:
                      type: object
                      additionalProperties:
                        type: string
                      description: Localized incipit title
                    alt_incipit_titles:
                      type: array
                      items:
                        type: object
                        additionalProperties:
                          type: string
                      description: Alternative localized incipit titles
                annotation:
                  type: array
                  items:
                    oneOf:
                      - type: object
                        required: [span]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                        description: Segmentation annotation (for CRITICAL manifestations)
                      - type: object
                        required: [span, reference]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                          reference:
                            type: string
                            description: Page/folio reference for the span
                        description: Pagination annotation (for DIPLOMATIC manifestations)
                      - type: object
                        required: [span, type]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                          type:
                            type: string
                            enum: [colophon, title, incipit_title, author]
                            description: Type of bibliography annotation
                        description: Bibliography annotation
                  description: Segmentation or pagination or bibliography annotation segments
                biblography_annotation:
                  type: array
                  items:
                    type: object
                    required: [span, type]
                    properties:
                      span:
                        type: object
                        required: [start, end]
                        properties:
                          start:
                            type: integer
                            minimum: 0
                            description: Start character position (inclusive)
                          end:
                            type: integer
                            minimum: 1
                            description: End character position (exclusive)
                      type:
                        type: string
                        enum: [colophon, title, incipit_title, author]
                        description: Type of bibliography annotation
                  description: Bibliography annotation segments with bibliography type
                content:
                  type: string
                  description: The text content
            examples:
              valid_diplomatic_instance_with_annotation:
                summary: Valid diplomatic instance creation with annotation
                value:
                  metadata:
                    type: "diplomatic"
                    source: "source-name"
                    bdrc: "W123456"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  annotation:
                    - span:
                        start: 0
                        end: 10
                      reference: "https://example.com/image1.png"
                    - span:
                        start: 11
                        end: 20
                      reference: "https://example.com/image2.png"
                  content: "This is the text content to be stored"
              valid_critical_instance_with_annotation:
                summary: Valid critical instance creation with annotation
                value:
                  metadata:
                    type: "critical"
                    source: "source-name"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  annotation:
                    - span:
                        start: 0
                        end: 10
                    - span:
                        start: 10
                        end: 20
                  content: "This is the text content to be stored"
              valid_critical_instance_without_annotation:
                summary: Valid critical instance creation without annotation
                value:
                  metadata:
                    type: "critical"
                    source: "source-name"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  content: "This is the text content to be stored"
              valid_diplomatic_instance_without_annotation:
                summary: Valid diplomatic instance creation without annotation
                value:
                  metadata:
                    type: "diplomatic"
                    source: "source-name"
                    bdrc: "W123456"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  content: "This is the text content to be stored"
              valid_diplomatic_instance_with_bibliography_annotation:
                summary: Valid diplomatic instance creation with bibliography annotation
                value:
                  metadata:
                    type: "diplomatic"
                    source: "source-name"
                    bdrc: "W123456"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  annotation:
                    - span:
                        start: 0
                        end: 10
                      reference: "ref-001"
                    - span:
                        start: 10
                        end: 20
                      reference: "ref-002"
                  biblography_annotation:
                    - span:
                        start: 5
                        end: 15
                      type: "colophon"
                    - span:
                        start: 20
                        end: 30
                      type: "title"
                  content: "This is the text content to be stored"
              valid_critical_instance_with_bibliography_annotation:
                summary: Valid critical instance creation with bibliography annotation
                value:
                  metadata:
                    type: "critical"
                    source: "source-name"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  annotation:
                    - span:
                        start: 0
                        end: 10
                    - span:
                        start: 10
                        end: 20
                  biblography_annotation:
                    - span:
                        start: 5
                        end: 15
                      type: "colophon"
                    - span:
                        start: 20
                        end: 30
                      type: "title"
                  content: "This is the text content to be stored"
      responses:
        "201":
          description: Instance created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - "Instance created successfully"
                  id:
                    type: string
                    examples:
                      - "ABC12345678"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/ServerError"

  # NOTE: /v2/editions/{edition_id}/translation and /v2/editions/{edition_id}/commentary
  # endpoints have been REMOVED. To create translations or commentaries, use:
  # 1. POST /v2/texts with translation_of or commentary_of field
  # 2. POST /v2/texts/{text_id}/editions to create the edition

  /v2/texts:
    get:
      summary: Retrieve all texts
      description: Fetch all texts with optional filtering and pagination
      tags:
        - Texts
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of results per page
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip
        - name: language
          in: query
          required: false
          schema:
            type: string
          description: Filter by language code
        - name: title
          in: query
          required: false
          schema:
            type: string
          description: Filter by title (case-insensitive substring match)
        - name: category_id
          in: query
          required: false
          schema:
            type: string
          description: Filter by category ID
      responses:
        "200":
          description: Texts retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ExpressionOutput"
              examples:
                success:
                  summary: List of texts
                  value:
                    - id: "ABC12345678"
                      title:
                        en: "Sample Expression"
                        bo: "དཔེ་མཚོན་ཚིག་སྒྲུབ།"
                      language: "bo"
                      category_id: "CAT12345678"
                      contributions:
                        - person_id: "P12345678"
                          role: "author"
                      license: "public"
                      commentaries: []
                      translations: ["DEF87654321"]
                      editions: ["M12345678"]
                    - id: "DEF87654321"
                      title:
                        en: "AI Generated Translation"
                      language: "en"
                      category_id: "CAT12345678"
                      translation_of: "ABC12345678"
                      contributions:
                        - ai_id: "gpt-4"
                          role: "translator"
                      license: "cc0"
                      commentaries: []
                      translations: []
                      editions: []
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "500":
          $ref: "#/components/responses/ServerError"

    post:
      summary: Create text
      description: Create a new text record
      tags:
        - Texts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExpressionInput"
            examples:
              root_text:
                summary: Root text creation
                value:
                  title:
                    en: "Sample Root Text"
                    bo: "རྩ་བའི་གཞུང་དཔེ།"
                  language: "bo"
                  category_id: "CAT12345678"
                  contributions:
                    - person_id: "P12345678"
                      role: "author"
                  bdrc: "W123456"
              translation_text:
                summary: Translation text creation
                value:
                  title:
                    en: "English Translation"
                  language: "en"
                  category_id: "CAT12345678"
                  translation_of: "ABC12345678"
                  contributions:
                    - person_bdrc_id: "P87654321"
                      role: "translator"
              commentary_text:
                summary: Commentary text creation
                value:
                  title:
                    bo: "འགྲེལ་པ།"
                  language: "bo"
                  category_id: "CAT12345678"
                  commentary_of: "ABC12345678"
                  contributions:
                    - person_id: "P12345678"
                      role: "author"
              ai_translation_text:
                summary: AI translation text creation
                value:
                  title:
                    en: "AI English Translation"
                  language: "en"
                  category_id: "CAT12345678"
                  translation_of: "ABC12345678"
                  contributions:
                    - ai_id: "gpt-4"
                      role: "translator"
      responses:
        "201":
          description: Text created successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - id
                properties:
                  id:
                    type: string
                    description: The ID of the newly created expression
              examples:
                created:
                  summary: Text created
                  value:
                    id: "T12345678"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/texts/{id}:
    get:
      summary: Retrieve text by ID or BDRC ID
      description: Fetch a specific text by its expression ID or BDRC ID
      tags:
        - Texts
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: The ID or BDRC ID of the text to retrieve
      responses:
        "200":
          description: Text retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExpressionOutput"
              examples:
                root_text:
                  summary: Root text
                  value:
                    id: "T12345678"
                    title:
                      en: "Sample Expression"
                      bo: "དཔེ་མཚོན་ཚིག་སྒྲུབ།"
                    language: "bo"
                    category_id: "CAT12345678"
                    contributions:
                      - person_id: "P12345678"
                        role: "author"
                    bdrc: "W123456"
                    license: "public"
                    commentaries: ["C12345678"]
                    translations: ["TR12345678"]
                    editions: ["M12345678"]
                translation_text:
                  summary: Translation text
                  value:
                    id: "TR12345678"
                    title:
                      en: "English Translation"
                    language: "en"
                    category_id: "CAT12345678"
                    translation_of: "T12345678"
                    contributions:
                      - person_id: "P87654321"
                        role: "translator"
                    license: "cc0"
                    commentaries: []
                    translations: []
                    editions: []
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/texts/{texts_id}/group:
    get:
      summary: Retrieve texts group by text ID
      description: Fetch all texts in the same work group as the specified text ID
      tags:
        - Texts
      parameters:
        - name: texts_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the text to retrieve the group for
      responses:
        "200":
          description: Texts group retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  texts:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        type:
                          type: string
                          enum: [root, translation, commentary, none]
                        title:
                          type: object
                          additionalProperties:
                            type: string
                        alt_titles:
                          type: array
                          items:
                            type: object
                            additionalProperties:
                              type: string
                          nullable: true
                        language:
                          type: string
                        contributions:
                          type: array
                          items:
                            type: object
                            properties:
                              person_id:
                                type: string
                                nullable: true
                              person_bdrc_id:
                                type: string
                                nullable: true
                              ai_id:
                                type: string
                                nullable: true
                              role:
                                type: string
                                enum: [author, translator, reviser, scholar]
                        date:
                          type: string
                          nullable: true
                        bdrc:
                          type: string
                          nullable: true
                        wiki:
                          type: string
                          nullable: true
                        target:
                          type: string
                          nullable: true
                        category_id:
                          type: string
                          nullable: true
                        copyright:
                          type: string
                          enum: ["Public domain", "In copyright", "Unknown"]
                        license:
                          type: string
                          nullable: true

              examples:
                success:
                  summary: Texts group response
                  value:
                    texts:
                      - id: "T12345679"
                        type: "translation"
                        title:
                          en: "Translation of Sample Text"
                          bo: "དཔེ་མཚོན་ཚིག་སྒྲུབ་ཀྱི་སྒྱུར་བ།"
                        language: "en"
                        contributions:
                          - person_id: "P87654321"
                            role: "translator"
                        target: "T12345678"
                        category_id: "C12345678"
                        copyright: "Public domain"
                        license: "CC0"
                      - id: "T12345680"
                        type: "commentary"
                        title:
                          bo: "དཔེ་མཚོན་ཚིག་སྒྲུབ་ཀྱི་འགྲེལ་བ།"
                        language: "bo"
                        contributions:
                          - person_id: "P11111111"
                            role: "author"
                        target: "T12345678"
                        copyright: "Public domain"
                        category_id: "C12345678"
                        license: "CC0"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/texts/{text_id}/related-by-work:
    get:
      summary: Get texts grouped by work ID
      description: >-
        Returns texts grouped by their work_id for all related texts.
        This allows you to easily identify which texts belong to the same work.

        Takes a text ID directly and finds all related texts
        (translations, commentaries, roots, etc.), then returns them grouped by work_id
        with their relationship type.
      tags:
        - Texts
      parameters:
        - name: text_id
          in: path
          required: true
          schema:
            type: string
          description: The text ID
      responses:
        "200":
          description: Texts grouped by work retrieved successfully
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
                  properties:
                    relation:
                      type: string
                      nullable: true
                      enum:
                        [
                          translation,
                          commentary,
                          root,
                          sibling_root,
                          sibling_commentary,
                        ]
                      description: The relation type for texts in this work group
                    text_ids:
                      type: array
                      items:
                        type: string
                      description: List of text IDs in this work group
                description: Dictionary with work_id as key and object containing relation type and text IDs as value
                example:
                  "W001":
                    relation: "translation"
                    text_ids: ["T001", "T002", "T004"]
                  "W002":
                    relation: "commentary"
                    text_ids: ["T003"]
                  "W003":
                    relation: null
                    text_ids: ["T005"]
        "404":
          description: Text not found or has no relations
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Text with ID T123 not found"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/texts/{texts_id}/title:
    put:
      summary: Update texts title
      description: >-
        Update the title of a texts. The title should be provided as a dictionary
        with language code as the key and the title text as the value.
      tags:
        - Texts
      parameters:
        - name: texts_id
          in: path
          required: true
          schema:
            type: string
          description: The texts ID of the text to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
              properties:
                title:
                  type: object
                  description: Dictionary with language code as key and title text as value
                  additionalProperties:
                    type: string
                  example:
                    bo: "རྒྱལ་པོ་རབས་ཀྱི་གཏམ་རྒྱུད།"
      responses:
        "200":
          description: Title updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Title updated successfully"
        "400":
          description: Bad request - Invalid input
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Title is required"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/texts/{texts_id}/license:
    put:
      summary: Update texts license
      description: Update the license information for a texts
      tags:
        - Texts
      parameters:
        - name: texts_id
          in: path
          required: true
          schema:
            type: string
          description: The texts ID of the text to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - license
              properties:
                license:
                  $ref: "#/components/schemas/LicenseType"
      responses:
        "200":
          description: License updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "License updated successfully"
        "400":
          description: Bad request - Invalid input
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "License is required"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/persons:
    get:
      summary: Retrieve all persons
      description: Fetch all persons from the database with optional pagination
      tags:
        - Persons
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of results per page
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip
      responses:
        "200":
          description: Persons retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PersonOutput"
              examples:
                success:
                  summary: List of persons
                  value:
                    - id: "P12345678"
                      name:
                        en: "John Doe"
                        bo: "ཇོན་དོ།"
                      alt_names:
                        - en: "J. Doe"
                          bo: "ཇོན།"
                      bdrc: "P123456"
                      wiki: "Q123456"
        "500":
          $ref: "#/components/responses/ServerError"

    post:
      summary: Create a person
      description: Create a new person record
      tags:
        - Persons
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PersonInput"
            examples:
              valid_person:
                summary: Valid person creation
                value:
                  name:
                    en: "John Doe"
                    bo: "ཇོན་དོ།"
                  alt_names:
                    - en: "J. Doe"
                      bo: "ཇོན།"
                  bdrc: "P123456"
                  wiki: "Q123456"
      responses:
        "201":
          description: Person created successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - id
                properties:
                  id:
                    type: string
                    description: The ID of the created person
              examples:
                success:
                  summary: Person created
                  value:
                    id: "P12345678"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/persons/{person_id}:
    get:
      summary: Retrieve person by ID
      description: Fetch a specific person by their ID
      tags:
        - Persons
      parameters:
        - name: person_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the person to retrieve
      responses:
        "200":
          description: Person retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PersonOutput"
              examples:
                success:
                  summary: Single person
                  value:
                    id: "P12345678"
                    name:
                      en: "John Doe"
                      bo: "ཇོན་དོ།"
                    alt_names:
                      - en: "J. Doe"
                        bo: "ཇོན།"
                    bdrc: "P123456"
                    wiki: "Q123456"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/annotations/segmentation/{segmentation_id}:
    get:
      summary: Retrieve segmentation annotation by ID
      description: Fetch a specific segmentation annotation with all its segments
      tags:
        - Annotations
      parameters:
        - name: segmentation_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the segmentation annotation to retrieve
      responses:
        "200":
          description: Segmentation annotation retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SegmentationOutput"
              examples:
                segmentation:
                  summary: Segmentation with multiple segments
                  value:
                    id: "seg_abc123"
                    segments:
                      - id: "segment_001"
                        manifestation_id: "M12345678"
                        text_id: "E12345678"
                        lines:
                          - start: 0
                            end: 50
                      - id: "segment_002"
                        manifestation_id: "M12345678"
                        text_id: "E12345678"
                        lines:
                          - start: 50
                            end: 100
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
    delete:
      summary: Delete segmentation annotation
      description: Permanently delete a segmentation annotation and all its segments
      tags:
        - Annotations
      parameters:
        - name: segmentation_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the segmentation annotation to delete
      responses:
        "200":
          description: Segmentation deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Segmentation deleted successfully"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/annotations/alignment/{alignment_id}:
    get:
      summary: Retrieve alignment annotation by ID
      description: Fetch a specific alignment annotation with source and target segments
      tags:
        - Annotations
      parameters:
        - name: alignment_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the alignment annotation to retrieve
      responses:
        "200":
          description: Alignment annotation retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AlignmentOutput"
              examples:
                alignment:
                  summary: Alignment between two manifestations
                  value:
                    id: "align_abc123"
                    target_id: "M87654321"
                    target_segments:
                      - id: "target_seg_001"
                        manifestation_id: "M87654321"
                        text_id: "E87654321"
                        lines:
                          - start: 0
                            end: 30
                      - id: "target_seg_002"
                        manifestation_id: "M87654321"
                        text_id: "E87654321"
                        lines:
                          - start: 30
                            end: 60
                    aligned_segments:
                      - lines:
                          - start: 0
                            end: 25
                        alignment_indices: [0]
                      - lines:
                          - start: 25
                            end: 50
                        alignment_indices: [0, 1]
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
    delete:
      summary: Delete alignment annotation
      description: Permanently delete an alignment annotation and all its segments
      tags:
        - Annotations
      parameters:
        - name: alignment_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the alignment annotation to delete
      responses:
        "200":
          description: Alignment deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Alignment deleted successfully"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/annotations/pagination/{pagination_id}:
    get:
      summary: Retrieve pagination annotation by ID
      description: Fetch a specific pagination annotation with volume and page information
      tags:
        - Annotations
      parameters:
        - name: pagination_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the pagination annotation to retrieve
      responses:
        "200":
          description: Pagination annotation retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginationOutput"
              examples:
                pagination:
                  summary: Pagination with volume and pages
                  value:
                    id: "pag_abc123"
                    volume:
                      index: 1
                      pages:
                        - reference: "folio_1a"
                          lines:
                            - start: 0
                              end: 500
                        - reference: "folio_1b"
                          lines:
                            - start: 500
                              end: 1000
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
    delete:
      summary: Delete pagination annotation
      description: Permanently delete a pagination annotation and all its pages
      tags:
        - Annotations
      parameters:
        - name: pagination_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the pagination annotation to delete
      responses:
        "200":
          description: Pagination deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Pagination deleted successfully"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/annotations/durchen/{note_id}:
    get:
      summary: Retrieve durchen note by ID
      description: Fetch a specific durchen (critical apparatus) note
      tags:
        - Annotations
      parameters:
        - name: note_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the durchen note to retrieve
      responses:
        "200":
          description: Durchen note retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoteOutput"
              examples:
                durchen:
                  summary: Durchen note with span and text
                  value:
                    id: "note_abc123"
                    span:
                      start: 100
                      end: 150
                    text: "Variant reading found in manuscript B: འདི་ནི།"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
    delete:
      summary: Delete durchen note
      description: Permanently delete a durchen (critical apparatus) note
      tags:
        - Annotations
      parameters:
        - name: note_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the durchen note to delete
      responses:
        "200":
          description: Durchen note deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Durchen note deleted successfully"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/annotations/bibliographic/{bibliographic_id}:
    get:
      summary: Retrieve bibliographic metadata by ID
      description: Fetch a specific bibliographic metadata annotation (colophon, title, etc.)
      tags:
        - Annotations
      parameters:
        - name: bibliographic_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the bibliographic metadata to retrieve
      responses:
        "200":
          description: Bibliographic metadata retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BibliographicMetadataOutput"
              examples:
                bibliographic:
                  summary: Bibliographic metadata for a colophon
                  value:
                    id: "bib_abc123"
                    span:
                      start: 5000
                      end: 5500
                    type: "colophon"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
    delete:
      summary: Delete bibliographic metadata
      description: Permanently delete a bibliographic metadata annotation
      tags:
        - Annotations
      parameters:
        - name: bibliographic_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the bibliographic metadata to delete
      responses:
        "200":
          description: Bibliographic metadata deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Bibliographic metadata deleted successfully"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/editions/{edition_id}/annotations:
    get:
      summary: Get all annotations for an edition
      description: >-
        Retrieves all annotations for the specified edition (manifestation).
        Use the `type` query parameter to filter by annotation type(s).
        Multiple types can be specified by repeating the parameter.
      tags:
        - Editions
      parameters:
        - name: edition_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the edition (manifestation) to get annotations for
        - name: type
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
              enum: [segmentation, alignment, pagination, bibliography, durchen]
          style: form
          explode: true
          description: Filter by annotation type(s). If not specified, returns all types.
      responses:
        "200":
          description: Annotations retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnnotationRequestOutput"
              examples:
                all_annotations:
                  summary: All annotation types
                  value:
                    segmentations:
                      - id: "seg_abc123"
                        segments:
                          - id: "segment_001"
                            manifestation_id: "M12345678"
                            text_id: "E12345678"
                            lines:
                              - start: 0
                                end: 50
                    pagination:
                      id: "pag_abc123"
                      volume:
                        index: 1
                        pages:
                          - reference: "folio_1a"
                            lines:
                              - start: 0
                                end: 500
                    bibliographic_metadata:
                      - id: "bib_abc123"
                        span:
                          start: 5000
                          end: 5500
                        type: "colophon"
                    durchen_notes:
                      - id: "note_abc123"
                        span:
                          start: 100
                          end: 150
                        text: "Variant reading in manuscript B"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"
    post:
      summary: Add annotation to an edition
      description: >-
        Adds an annotation to the specified edition (manifestation).
        Exactly one annotation type must be provided per request.

        Supported annotation types:
        - **segmentation**: Text segmentation with segments containing lines (spans)
        - **alignment**: Alignment between this edition and a target edition
        - **pagination**: Page/folio references for diplomatic editions
        - **bibliographic_metadata**: Colophon, title, author spans
        - **durchen_notes**: Critical apparatus notes
      tags:
        - Editions
      parameters:
        - name: edition_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the edition (manifestation) to annotate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnnotationRequestInput"
            examples:
              segmentation:
                summary: Add segmentation annotation
                value:
                  segmentation:
                    segments:
                      - lines:
                          - start: 0
                            end: 50
                      - lines:
                          - start: 50
                            end: 100
              alignment:
                summary: Add alignment annotation
                value:
                  alignment:
                    target_id: "M87654321"
                    target_segments:
                      - lines:
                          - start: 0
                            end: 30
                      - lines:
                          - start: 30
                            end: 60
                    aligned_segments:
                      - lines:
                          - start: 0
                            end: 25
                        alignment_indices: [0]
                      - lines:
                          - start: 25
                            end: 50
                        alignment_indices: [0, 1]
              pagination:
                summary: Add pagination annotation
                value:
                  pagination:
                    volume:
                      index: 1
                      pages:
                        - reference: "folio_1a"
                          lines:
                            - start: 0
                              end: 500
                        - reference: "folio_1b"
                          lines:
                            - start: 500
                              end: 1000
              bibliographic:
                summary: Add bibliographic metadata
                value:
                  bibliographic_metadata:
                    - span:
                        start: 5000
                        end: 5500
                      type: "colophon"
                    - span:
                        start: 0
                        end: 100
                      type: "title"
              durchen:
                summary: Add durchen notes
                value:
                  durchen_notes:
                    - span:
                        start: 100
                        end: 150
                      text: "Variant reading found in manuscript B: འདི་ནི།"
      responses:
        "201":
          description: Annotation added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Annotation added successfully"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/segments/{segment_id}/related:
    get:
      summary: Find related segments
      description: Find all segments that are aligned to a specific segment
      tags:
        - Segments
      parameters:
        - name: segment_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the segment to find related segments for
      responses:
        "200":
          description: Related segments retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SegmentOutput"
              examples:
                success:
                  summary: List of related segments
                  value:
                    - id: "SEG001"
                      manifestation_id: "M12345678"
                      text_id: "E12345678"
                      lines:
                        - start: 0
                          end: 100
                    - id: "SEG002"
                      manifestation_id: "M12345678"
                      text_id: "E12345678"
                      lines:
                        - start: 100
                          end: 200
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/segments/{segment_id}/content:
    get:
      summary: Get segment text content
      description: Retrieve the base text content for a segment based on its character span
      tags:
        - Segments
      parameters:
        - name: segment_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the segment to retrieve text content for
      responses:
        "200":
          description: Segment content retrieved successfully
          content:
            application/json:
              schema:
                type: string
                description: The text content of the segment
              examples:
                success:
                  summary: Segment text content
                  value: "This is the text content of the segment."
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/segments/search:
    get:
      summary: Search segments with segmentation mapping
      description: >-
        Search segments by forwarding request to external search API and enriching results
        with overlapping segmentation annotation segment IDs. For each search result (which contains
        a search_segmentation segment ID), finds overlapping segments from segmentation annotations
        and adds them as segmentation_ids.
      tags:
        - Segments
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
            minLength: 1
          description: The search query text
          example: "བོད་ཀྱི་རིག་གནས།"
        - name: search_type
          in: query
          required: false
          schema:
            type: string
            enum: [hybrid, bm25, semantic, exact]
            default: hybrid
          description: Type of search (hybrid, bm25, semantic, or exact)
          example: "hybrid"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Maximum number of results to return
          example: 10
        - name: title
          in: query
          required: false
          schema:
            type: string
          description: Filter results by title
          example: "Kangyur"
        - name: return_text
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Whether to include text content in search results
          example: true
      responses:
        "200":
          description: Search completed successfully with enriched results
          content:
            application/json:
              schema:
                type: object
                required:
                  - query
                  - search_type
                  - results
                  - count
                properties:
                  query:
                    type: string
                    description: The search query that was used
                  search_type:
                    type: string
                    description: The search type that was used
                  results:
                    type: array
                    description: List of search results with segmentation IDs
                    items:
                      type: object
                      required:
                        - id
                        - distance
                        - entity
                        - segmentation_ids
                      properties:
                        id:
                          type: string
                          description: Search segmentation segment ID
                        distance:
                          type: number
                          description: Search distance/score
                        entity:
                          type: object
                          additionalProperties: true
                          description: Additional entity data from search. Contains 'text' field when return_text=true
                        segmentation_ids:
                          type: array
                          items:
                            type: string
                          description: List of overlapping segmentation annotation segment IDs
                  count:
                    type: integer
                    description: Number of results returned
              examples:
                success:
                  summary: Search results with segmentation IDs
                  value:
                    query: "བོད་ཀྱི་རིག་གནས།"
                    search_type: "hybrid"
                    results:
                      - id: "SEG_SEARCH_001"
                        distance: 0.85
                        entity:
                          text: "Sample text content"
                        segmentation_ids:
                          - "SEG_001"
                          - "SEG_002"
                          - "SEG_003"
                      - id: "SEG_SEARCH_002"
                        distance: 0.78
                        entity:
                          text: "Another text content"
                        segmentation_ids:
                          - "SEG_004"
                          - "SEG_005"
                    count: 2
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/ServerError"

  # NOTE: /v2/segments/batch-overlapping endpoint has been REMOVED

  /v2/relations/expressions/{expression_id}:
    get:
      summary: Get relations for an expression
      description: Returns all relationships for a given expression, including direction and related expression IDs.
      tags:
        - Relations
      parameters:
        - name: expression_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the expression to retrieve relations for
      responses:
        "200":
          description: Relations retrieved successfully
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: array
                  items:
                    type: object
                    required: [type, direction, otherId]
                    properties:
                      type:
                        type: string
                        enum: [TRANSLATION_OF, COMMENTARY_OF]
                        description: Relationship type
                      direction:
                        type: string
                        enum: [in, out]
                        description: Direction relative to the expression
                      otherId:
                        type: string
                        description: Related expression ID
                description: Object where keys are expression IDs and values are arrays of relations
              examples:
                success:
                  summary: Relations for an expression
                  value:
                    "13mxFPmsmIqktVTYVV8AL":
                      - type: "TRANSLATION_OF"
                        direction: "in"
                        otherId: "RQKWt16H22fyxodz1Hpu8"
                      - type: "TRANSLATION_OF"
                        direction: "in"
                        otherId: "zRsb99ocU5fM8wurAUfMQ"
                      - type: "TRANSLATION_OF"
                        direction: "in"
                        otherId: "t0CzlMC69QUySNEBzSL4e"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/categories:
    get:
      summary: Retrieve categories
      description: Get categories filtered by application and optional parent
      tags:
        - Categories
      parameters:
        - name: application
          in: query
          required: true
          schema:
            type: string
          description: Application context for categories
          example: "webuddhist"
        - name: parent_id
          in: query
          required: false
          schema:
            type: string
            nullable: true
          description: Parent category ID (null or omitted means root categories)
      responses:
        "200":
          description: Categories retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CategoryOutput"
              examples:
                root_categories:
                  summary: Root categories
                  value:
                    - id: "CAT12345678"
                      parent_id: null
                      title:
                        en: "Literature"
                        bo: "རྩོམ་རིག"
                      has_children: true
                    - id: "CAT23456789"
                      parent_id: null
                      title:
                        en: "History"
                        bo: "ལོ་རྒྱུས"
                      has_children: false
                child_categories:
                  summary: Child categories
                  value:
                    - id: "CAT87654321"
                      parent_id: "CAT12345678"
                      title:
                        en: "Poetry"
                        bo: "སྙན་ངག"
                      has_children: false
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "500":
          $ref: "#/components/responses/ServerError"
    post:
      summary: Create a new category
      description: Create a category with localized title and optional parent relationship
      tags:
        - Categories
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategoryInput"
            examples:
              root_category:
                summary: Root category without parent
                value:
                  application: "webuddhist"
                  title:
                    en: "Literature"
                    bo: "རྩོམ་རིག"
              child_category:
                summary: Child category with parent
                value:
                  application: "webuddhist"
                  title:
                    en: "Poetry"
                    bo: "སྙན་ངག"
                  parent_id: "CAT12345678"
      responses:
        "201":
          description: Category created successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - id
                properties:
                  id:
                    type: string
                    description: Generated category ID
              examples:
                created:
                  summary: Category created
                  value:
                    id: "CAT12345678"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/categories/{category_id}/texts:
    get:
      summary: Retrieve texts by category (excluding commentary)
      description: Fetch texts that belong to a given category with optional filtering and pagination. Commentary texts are excluded.
      tags:
        - Texts
      parameters:
        - name: category_id
          in: path
          required: true
          schema:
            type: string
          description: Category ID
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of results per page
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip
        - name: language
          in: query
          required: false
          schema:
            type: string
          description: Filter by expression language code (e.g., "bo", "en")
        - name: edition_type
          in: query
          required: false
          schema:
            type: string
            enum: [diplomatic, critical, all]
            default: all
          description: Require texts to have at least one instance of the given type
      responses:
        "200":
          description: Text and instance metadata retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    text_metadata:
                      type: object
                      properties:
                        id:
                          type: string
                        type:
                          type: string
                          enum: [root, commentary, translation]
                        title:
                          type: object
                          additionalProperties:
                            type: string
                          description: Localized expression title map (language code to text)
                        alt_titles:
                          type: array
                          items:
                            type: object
                            additionalProperties:
                              type: string
                        language:
                          type: string
                        contributions:
                          type: array
                          items:
                            type: object
                            properties:
                              person_id:
                                type: string
                              person_bdrc_id:
                                type: string
                              ai_id:
                                type: string
                              role:
                                type: string
                        date:
                          type: string
                        bdrc:
                          type: string
                        wiki:
                          type: string
                        target:
                          type: string
                          nullable: true
                        category_id:
                          type: string
                          nullable: true
                    instance_metadata:
                      type: array
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                          type:
                            type: string
                            enum: [diplomatic, critical]
                          copyright:
                            type: string
                          bdrc:
                            type: string
                          wiki:
                            type: string
                          colophon:
                            type: string
                          incipit_title:
                            type: object
                            additionalProperties:
                              type: string
                            description: Localized instance title (incipit) map (language code to text)
                          alt_incipit_titles:
                            type: array
                            items:
                              type: object
                              additionalProperties:
                                type: string
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "500":
          $ref: "#/components/responses/ServerError"

  /v2/enum:
    get:
      summary: List enum entries
      description: Retrieve enum values by type. Defaults to language if type is not provided.
      tags:
        - Enums
      parameters:
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [language, bibliography, manifestation, role, annotation]
            default: language
          description: Enum type to list
      responses:
        "200":
          description: Enums retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  type:
                    type: string
                    enum:
                      [language, bibliography, manifestation, role, annotation]
                  items:
                    type: array
                    items:
                      type: object
              examples:
                language:
                  summary: Language enums
                  value:
                    type: language
                    items:
                      - code: bo
                        name: tibetan
                      - code: en
                        name: english
                bibliography:
                  summary: Bibliography enums
                  value:
                    type: bibliography
                    items:
                      - name: colophon
                      - name: title
                manifestation:
                  summary: Manifestation enums
                  value:
                    type: manifestation
                    items:
                      - name: diplomatic
                      - name: critical
                role:
                  summary: Role enums
                  value:
                    type: role
                    items:
                      - name: author
                        description: writer of the work
                      - name: translator
                        description: translated the work
                annotation:
                  summary: Annotation enums
                  value:
                    type: annotation
                    items:
                      - name: segmentation
                      - name: pagination
    post:
      summary: Create enum entries
      description: Create one or more enum values in Neo4j based on the provided type and values payload. All values are normalized to lowercase before storage. Supports batch creation with error handling for individual items.
      tags:
        - Enums
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, values]
              properties:
                type:
                  type: string
                  enum:
                    [language, bibliography, manifestation, role, annotation]
                  description: Enum type to create
                values:
                  type: array
                  minItems: 1
                  description: Array of enum values to create
                  items:
                    oneOf:
                      - title: LanguageValue
                        type: object
                        required: [code, name]
                        properties:
                          code:
                            type: string
                          name:
                            type: string
                      - title: BibliographyValue
                        type: object
                        required: [name]
                        properties:
                          name:
                            type: string
                      - title: ManifestationValue
                        type: object
                        required: [name]
                        properties:
                          name:
                            type: string
                      - title: RoleValue
                        type: object
                        required: [description, name]
                        properties:
                          description:
                            type: string
                          name:
                            type: string
                      - title: AnnotationValue
                        type: object
                        required: [name]
                        properties:
                          name:
                            type: string
            examples:
              language_single:
                summary: Create single language enum
                value:
                  type: language
                  values:
                    - code: bo
                      name: Tibetan
              language_multiple:
                summary: Create multiple language enums
                value:
                  type: language
                  values:
                    - code: bo
                      name: Tibetan
                    - code: en
                      name: English
                    - code: zh
                      name: Chinese
              bibliography:
                summary: Create multiple bibliography enums
                value:
                  type: bibliography
                  values:
                    - name: colophon
                    - name: preface
                    - name: introduction
              manifestation:
                summary: Create multiple manifestation enums
                value:
                  type: manifestation
                  values:
                    - name: diplomatic
                    - name: critical
              role:
                summary: Create multiple role enums
                value:
                  type: role
                  values:
                    - description: Writer of the work
                      name: author
                    - description: Translator of the work
                      name: translator
              annotation:
                summary: Create multiple annotation enums
                value:
                  type: annotation
                  values:
                    - name: segmentation
                    - name: pagination
      responses:
        "201":
          description: Enum entries created successfully (or partially created with errors)
          content:
            application/json:
              schema:
                type: object
                required: [message, created_count, failed_count]
                properties:
                  message:
                    type: string
                    description: Summary message of the operation
                  created_count:
                    type: integer
                    description: Number of successfully created enum entries
                  failed_count:
                    type: integer
                    description: Number of failed enum entries
                  failed_items:
                    type: array
                    description: Details of failed items (only present if failed_count > 0)
                    items:
                      type: object
                      properties:
                        index:
                          type: integer
                          description: Index of the failed item in the values array
                        value:
                          type: object
                          description: The value that failed to be created
                        error:
                          type: string
                          description: Error message explaining the failure
              examples:
                all_success:
                  summary: All items created successfully
                  value:
                    message: "3 language(s) created successfully"
                    created_count: 3
                    failed_count: 0
                partial_success:
                  summary: Partial success with some failures
                  value:
                    message: "2 language(s) created successfully"
                    created_count: 2
                    failed_count: 1
                    failed_items:
                      - index: 1
                        value:
                          code: en
                          name: English
                        error: "Language enum already exists"
        "400":
          $ref: "#/components/responses/InvalidRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "500":
          $ref: "#/components/responses/ServerError"

  /api/version:
    get:
      summary: Get API version and Git SHA
      description: Returns the current API version and the Git commit SHA of the deployed code.
      operationId: getVersion
      tags:
        - API
      responses:
        "200":
          description: Successfully retrieved version information
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                    examples:
                      - "0.1.0"
                  git_sha:
                    type: string
                    examples:
                      - "b706d2b1a5d0176df374da25c970274b2e0f7770"
        "500":
          $ref: "#/components/responses/ServerError"

components:
  schemas:
    CategoryInput:
      type: object
      required:
        - application
        - title
      properties:
        application:
          type: string
          description: Application context for the category
        title:
          type: object
          additionalProperties:
            type: string
          description: Localized category titles (language code to text mapping)
        parent_id:
          type: string
          nullable: true
          description: Parent category ID (optional, null for root categories)

    CategoryOutput:
      type: object
      required:
        - id
        - title
        - has_children
      properties:
        id:
          type: string
          description: Category ID
        title:
          type: object
          additionalProperties:
            type: string
          description: Localized category titles
        parent_id:
          type: string
          nullable: true
          description: Parent category ID (null for root categories)
        has_children:
          type: boolean
          description: Whether this category has child categories

    ContributionInput:
      type: object
      description: Human or AI contribution. Must provide either person_id OR person_bdrc_id for human contributions, or ai_id for AI contributions.
      required:
        - role
      properties:
        person_id:
          type: string
          description: Person ID (for human contributions)
        person_bdrc_id:
          type: string
          description: Person BDRC ID (for human contributions)
        ai_id:
          type: string
          description: AI model identifier (for AI contributions)
        role:
          type: string
          enum: [author, translator, reviser, scholar]

    ContributionOutput:
      type: object
      required:
        - role
      properties:
        person_id:
          type: string
          nullable: true
        person_bdrc_id:
          type: string
          nullable: true
        ai_id:
          type: string
          nullable: true
        role:
          type: string
          enum: [author, translator, reviser, scholar]

    ExpressionInput:
      type: object
      required:
        - title
        - language
        - category_id
        - contributions
      properties:
        bdrc:
          type: string
          nullable: true
          description: BDRC identifier
        wiki:
          type: string
          nullable: true
          description: Wikidata identifier
        date:
          type: string
          nullable: true
          description: Date of composition
        title:
          type: object
          additionalProperties:
            type: string
          description: Localized title (language code to text mapping)
        alt_titles:
          type: array
          nullable: true
          items:
            type: object
            additionalProperties:
              type: string
          description: Alternative localized titles
        language:
          type: string
          description: Primary language code
        commentary_of:
          type: string
          nullable: true
          description: ID of the text this is a commentary of
        translation_of:
          type: string
          nullable: true
          description: ID of the text this is a translation of
        category_id:
          type: string
          description: Category ID this text belongs to
        license:
          $ref: "#/components/schemas/LicenseType"
        contributions:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/ContributionInput"

    ExpressionOutput:
      type: object
      required:
        - id
        - title
        - language
        - category_id
        - contributions
        - license
        - commentaries
        - translations
        - editions
      properties:
        id:
          type: string
          description: Expression ID
        bdrc:
          type: string
          nullable: true
        wiki:
          type: string
          nullable: true
        date:
          type: string
          nullable: true
        title:
          type: object
          additionalProperties:
            type: string
        alt_titles:
          type: array
          nullable: true
          items:
            type: object
            additionalProperties:
              type: string
        language:
          type: string
        commentary_of:
          type: string
          nullable: true
          description: ID of the text this is a commentary of
        translation_of:
          type: string
          nullable: true
          description: ID of the text this is a translation of
        category_id:
          type: string
        license:
          $ref: "#/components/schemas/LicenseType"
        contributions:
          type: array
          items:
            $ref: "#/components/schemas/ContributionOutput"
        commentaries:
          type: array
          items:
            type: string
          description: IDs of commentaries on this text
        translations:
          type: array
          items:
            type: string
          description: IDs of translations of this text
        editions:
          type: array
          items:
            type: string
          description: IDs of editions (manifestations) of this text

    LicenseType:
      type: string
      enum:
        - cc0
        - public
        - cc-by
        - cc-by-sa
        - cc-by-nd
        - cc-by-nc
        - cc-by-nc-sa
        - cc-by-nc-nd
        - copyrighted
        - unknown
      description: License type for content

    ManifestationType:
      type: string
      enum:
        - diplomatic
        - critical
        - collated
      description: Type of manifestation/edition

    ManifestationInput:
      type: object
      required:
        - type
      properties:
        bdrc:
          type: string
          nullable: true
          description: BDRC identifier (required for diplomatic, forbidden for critical)
        wiki:
          type: string
          nullable: true
          description: Wikidata identifier
        type:
          $ref: "#/components/schemas/ManifestationType"
        source:
          type: string
          nullable: true
          description: Source of the manifestation
        colophon:
          type: string
          nullable: true
          description: Colophon text
        incipit_title:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Localized incipit title
        alt_incipit_titles:
          type: array
          nullable: true
          items:
            type: object
            additionalProperties:
              type: string
          description: Alternative incipit titles

    ManifestationOutput:
      type: object
      required:
        - id
        - text_id
        - type
      properties:
        id:
          type: string
          description: Manifestation ID
        text_id:
          type: string
          description: Associated text/expression ID
        bdrc:
          type: string
          nullable: true
        wiki:
          type: string
          nullable: true
        type:
          $ref: "#/components/schemas/ManifestationType"
        source:
          type: string
          nullable: true
        colophon:
          type: string
          nullable: true
        incipit_title:
          type: object
          additionalProperties:
            type: string
          nullable: true
        alt_incipit_titles:
          type: array
          nullable: true
          items:
            type: object
            additionalProperties:
              type: string

    SpanModel:
      type: object
      required: [start, end]
      properties:
        start:
          type: integer
          minimum: 0
          description: Start character position (inclusive)
        end:
          type: integer
          minimum: 1
          description: End character position (exclusive)

    SegmentOutput:
      type: object
      required: [id, manifestation_id, text_id, lines]
      properties:
        id:
          type: string
          description: Unique segment identifier
        manifestation_id:
          type: string
          description: ID of the manifestation this segment belongs to
        text_id:
          type: string
          description: ID of the expression (text) this segment belongs to
        lines:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/SpanModel"
          description: Character spans that make up this segment

    AlignedSegment:
      type: object
      required: [lines, alignment_indices]
      properties:
        lines:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/SpanModel"
          description: Character spans for this aligned segment
        alignment_indices:
          type: array
          minItems: 1
          items:
            type: integer
          description: Indices of target segments this segment aligns to

    SegmentationOutput:
      type: object
      required: [id, segments]
      properties:
        id:
          type: string
          description: Segmentation annotation ID
        segments:
          type: array
          items:
            $ref: "#/components/schemas/SegmentOutput"
          description: List of segments in this segmentation
        metadata:
          type: object
          nullable: true
          description: Optional annotation metadata

    AlignmentOutput:
      type: object
      required: [id, target_id, target_segments, aligned_segments]
      properties:
        id:
          type: string
          description: Alignment annotation ID
        target_id:
          type: string
          description: ID of the target manifestation
        target_segments:
          type: array
          items:
            $ref: "#/components/schemas/SegmentOutput"
          description: Segments from the target manifestation
        aligned_segments:
          type: array
          items:
            $ref: "#/components/schemas/AlignedSegment"
          description: Aligned segments with their alignment indices
        metadata:
          type: object
          nullable: true
          description: Optional annotation metadata

    PageModel:
      type: object
      required: [reference, lines]
      properties:
        reference:
          type: string
          description: Page/folio reference (e.g., "folio_1a")
        lines:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/SpanModel"
          description: Character spans for this page

    VolumeModel:
      type: object
      required: [pages]
      properties:
        index:
          type: integer
          nullable: true
          description: Volume index (optional)
        pages:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/PageModel"
          description: Pages in this volume
        metadata:
          type: object
          nullable: true
          description: Optional volume metadata

    PaginationOutput:
      type: object
      required: [id, volume]
      properties:
        id:
          type: string
          description: Pagination annotation ID
        volume:
          $ref: "#/components/schemas/VolumeModel"
        metadata:
          type: object
          nullable: true
          description: Optional annotation metadata

    NoteOutput:
      type: object
      required: [id, span, text]
      properties:
        id:
          type: string
          description: Note ID
        span:
          $ref: "#/components/schemas/SpanModel"
        text:
          type: string
          description: The note content
        metadata:
          type: object
          nullable: true
          description: Optional annotation metadata

    BibliographicMetadataOutput:
      type: object
      required: [id, span, type]
      properties:
        id:
          type: string
          description: Bibliographic metadata ID
        span:
          $ref: "#/components/schemas/SpanModel"
        type:
          type: string
          enum: [colophon, title, incipit_title, author]
          description: Type of bibliographic metadata
        metadata:
          type: object
          nullable: true
          description: Optional annotation metadata

    SegmentationInput:
      type: object
      required: [segments]
      properties:
        segments:
          type: array
          minItems: 1
          items:
            type: object
            required: [lines]
            properties:
              lines:
                type: array
                minItems: 1
                items:
                  $ref: "#/components/schemas/SpanModel"
        metadata:
          type: object
          nullable: true

    AlignmentInput:
      type: object
      required: [target_id, target_segments, aligned_segments]
      properties:
        target_id:
          type: string
          description: ID of the target manifestation
        target_segments:
          type: array
          minItems: 1
          items:
            type: object
            required: [lines]
            properties:
              lines:
                type: array
                minItems: 1
                items:
                  $ref: "#/components/schemas/SpanModel"
        aligned_segments:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/AlignedSegment"
        metadata:
          type: object
          nullable: true

    PaginationInput:
      type: object
      required: [volume]
      properties:
        volume:
          $ref: "#/components/schemas/VolumeModel"
        metadata:
          type: object
          nullable: true

    BibliographicMetadataInput:
      type: object
      required: [span, type]
      properties:
        span:
          $ref: "#/components/schemas/SpanModel"
        type:
          type: string
          enum: [colophon, title, incipit_title, author]
        metadata:
          type: object
          nullable: true

    NoteInput:
      type: object
      required: [span, text]
      properties:
        span:
          $ref: "#/components/schemas/SpanModel"
        text:
          type: string
        metadata:
          type: object
          nullable: true

    AnnotationRequestInput:
      type: object
      description: Request body for adding annotations. Exactly one annotation type must be provided.
      properties:
        segmentation:
          $ref: "#/components/schemas/SegmentationInput"
        alignment:
          $ref: "#/components/schemas/AlignmentInput"
        pagination:
          $ref: "#/components/schemas/PaginationInput"
        bibliographic_metadata:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/BibliographicMetadataInput"
        durchen_notes:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/NoteInput"

    AnnotationRequestOutput:
      type: object
      description: Response containing annotations for an edition
      properties:
        segmentations:
          type: array
          nullable: true
          items:
            $ref: "#/components/schemas/SegmentationOutput"
        alignments:
          type: array
          nullable: true
          items:
            $ref: "#/components/schemas/AlignmentOutput"
        pagination:
          $ref: "#/components/schemas/PaginationOutput"
          nullable: true
        bibliographic_metadata:
          type: array
          nullable: true
          items:
            $ref: "#/components/schemas/BibliographicMetadataOutput"
        durchen_notes:
          type: array
          nullable: true
          items:
            $ref: "#/components/schemas/NoteOutput"

    PersonInput:
      type: object
      required:
        - name
      properties:
        bdrc:
          type: string
          nullable: true
          description: BDRC identifier
        wiki:
          type: string
          nullable: true
          description: Wikidata identifier
        name:
          type: object
          additionalProperties:
            type: string
          description: Localized name (language code -> name)
        alt_names:
          type: array
          nullable: true
          items:
            type: object
            additionalProperties:
              type: string
          description: Alternative localized names

    PersonOutput:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: Person ID
        bdrc:
          type: string
          nullable: true
        wiki:
          type: string
          nullable: true
        name:
          type: object
          additionalProperties:
            type: string
          description: Localized name (language code -> name)
        alt_names:
          type: array
          nullable: true
          items:
            type: object
            additionalProperties:
              type: string
          description: Alternative localized names

  responses:
    InvalidRequest:
      description: There was an error with the request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "There was an error with the request"
            required:
              - error

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "Resource was not found"
            required:
              - error

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: array
                items:
                  type: object
                  properties:
                    loc:
                      type: array
                      items:
                        type: string
                    msg:
                      type: string
                    type:
                      type: string
            required:
              - error
              - details
          examples:
            fieldMissing:
              value:
                error: "Validation error"
                details:
                  [
                    {
                      "loc": ["body", "title"],
                      "msg": "field required",
                      "type": "value_error.missing",
                    },
                  ]

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "There was an error on the server"
            required:
              - error
