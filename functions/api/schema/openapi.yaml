openapi: '3.1.0'
info:
  title: OpenPecha API
  version: '0.1.0'
servers:
  - url: https://api-aq25662yyq-uc.a.run.app
    description: Production
  - url: https://api-l25bgmwqoa-uc.a.run.app
    description: Development

paths:
  /pecha:
    post:
      summary: Create a Pecha
      description: Accepts a text document (.docx) and associated metadata in JSON format, processes them, and stores the resulting Pecha in the database.
      tags:
        - Pecha
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - text
                - metadata
              properties:
                text:
                  type: string
                  format: binary
                  description: The uploaded text file (must be .docx format).
                metadata:
                  type: string
                  format: json
                  description: JSON-encoded metadata describing the document. The structure follows [metadata schema](https://pecha-backend.web.app/schema/metadata).
      responses:
        "200":
          description: Successfully published the text document.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - Text published successfully
                  id:
                    type: string
                    description: The ID of the newly created Pecha.
                    examples: 
                      - I857977C3
                  title:
                    type: string
                    description: The title of the newly created Pecha, in the language of the text
                    examples:
                      - "Illuminating the Intent"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "409":
          $ref: '#/components/responses/ConflictError'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'
  /pecha/{pecha_id}:
    get:
      summary: Retrieve a Pecha OPF File
      description: Returns the OPF ZIP file for a given Pecha ID.
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha whose OPF file is requested.
      responses:
        "200":
          description: Successfully retrieved the OPF ZIP file.
          content:
            application/zip:
              schema:
                type: string
                format: binary
              examples:
                success:
                  summary: OPF ZIP File Download
                  description: The OPF ZIP file for a given Pecha ID.
                  value: (binary content of the ZIP file)
          headers:
            Content-Disposition:
              description: Suggests the filename for download.
              schema:
                type: string
              examples:
                attachment:
                  summary: File Attachment Header
                  description: Indicates the file should be downloaded.
                  value: "attachment; filename=I857977C3.zip"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'
    delete:
      summary: Delete a Pecha
      description: Deletes a Pecha from the database.
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha to be deleted.
      responses:
        "200":
          description: Pecha deleted successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    examples:
                      - I857977C3
                  message:
                    type: string
                    examples:
                      - Pecha deleted successfully
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'
  /pecha/{pecha_id}/publish:
    post:
      summary: Publish a Pecha to Pecha.org
      description: The Pecha referenced by the ID in the path will be serialized, and the result uploaded to Pecha.org
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha to be published.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                destination:
                  type: string
                  enum: [staging, production]
                  description: The destination to publish the Pecha to.
                reserialize:
                  type: boolean
                  default: false
                  description: Whether to re-serialize the Pecha before publishing.
      responses:
        "200":
          description: Pecha published successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - Pecha published successfully
                  id:
                    type: string
                    examples: 
                    - I857977C3
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "500":
          $ref: '#/components/responses/ServerError'
  /languages:
    get:
      summary: Retrieve the list of available languages
      description: Fetches all available languages from DB, returning an array where each item contains a language code and name.
      tags:
        - Other
      responses:
        "200":
          description: Successfully retrieved the list of languages.
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    code:
                      type: string
                      description: The ISO language code.
                      examples:
                        - bo
                    name:
                      type: string
                      description: The name of the language.
                      examples:
                        - Tibetan
        "500":
          $ref: '#/components/responses/ServerError'
  /metadata/{pecha_id}:
    get:
      summary: Retrieve metadata by Pecha ID
      description: Fetch metadata associated with the given Pecha
      tags:
        - Metadata
      parameters:
        - name: pecha_id
          in: path
          required: true
          description: The Pecha whose metadata is being requested.
          schema:
            type: string
      responses:
        "200":
          description: Metadata retrieved successfully
          content:
            application/json:
              schema:
                $ref: "https://pecha-backend.web.app/schema/metadata"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'
    put:
      summary: Overwrite metadata by ID
      description: Overwrites metadata for a given Pecha ID in DB. The metadata must be valid.
      tags:
        - Metadata
      parameters:
        - name: pecha_id
          in: path
          required: true
          description: The Pecha ID whose metadata is being updated.
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                metadata:
                  type: object
                  description: The updated metadata object.
              required:
                - metadata
      responses:
        "200":
          description: Metadata updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - Metadata updated successfully
                  id:
                    type: string
                    examples:
                      - I62E00D78
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'
  /metadata/{pecha_id}/category:
    put:
      summary: Set category for a Pecha
      description: Assigns a category to a Pecha's metadata
      operationId: setCategory
      tags:
        - Category
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - category_id
              properties:
                category_id:
                  type: string
                  description: ID of the category to assign
            examples:
              valid:
                summary: Valid category assignment
                value:
                  category_id: "madhyamaka"
              empty:
                summary: Missing category ID
                value:
                  category_id: ""
      responses:
        '200':
          description: Category successfully updated
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - id
                properties:
                  message:
                    type: string
                  id:
                    type: string
              examples:
                success:
                  summary: Category updated successfully
                  value:
                    message: "Category updated successfully"
                    id: "I857977C3"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'
  /metadata/{pecha_id}/related:
    get:
      summary: Get related metadata chain
      description: |
        Returns a chain of metadata documents related to the specified pecha.
        Supports different traversal modes and relationship types.
      tags:
        - Metadata
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
            pattern: ^I[A-F0-9]{8}$
          description: ID of the pecha to get related metadata for
        - name: traversal
          in: query
          required: false
          schema:
            type: string
            enum: [upward, full_tree]
            default: full_tree
          description: |
            Traversal mode for finding related metadata:
            * upward - Only traverse up the reference chain
            * full_tree - Get the complete tree of related metadata
        - name: relationships
          in: query
          required: false
          schema:
            type: string
            pattern: ^(commentary|version|translation)(,(commentary|version|translation))*$
          description: |
            Comma-separated list of relationship types to consider.
            If not provided, all relationship types are used.
            Example: "commentary,version"
      responses:
        "200":
          description: List of related metadata found successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - id
                    - title
                  properties:
                    id:
                      type: string
                      pattern: ^I[A-F0-9]{8}$
                    title:
                      type: string
                    commentary_of:
                      type: string
                      pattern: ^I[A-F0-9]{8}$
                    version_of:
                      type: string
                      pattern: ^I[A-F0-9]{8}$
                    translation_of:
                      type: string
                      pattern: ^I[A-F0-9]{8}$
                examples:
                  - id: IBA00803F
                    title: Root Text
                    version_of: IBA008040
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'
  /metadata/filter:
    post:
      summary: Filter metadata
      description: |
        Filter metadata using **four possible modes**:
        
        1. **Single Field Query** - Search by a single metadata field.
        2. **AND Query** - Return results that match **all** given conditions.  
        3. **OR Query** - Return results that match **any** given conditions.
        4. **No Filters** - If the request body is empty, all Pechas are returned.
        
        Supports pagination with page and limit parameters.
      tags:
        - Metadata
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                filter:
                  $ref: "https://pecha-backend.web.app/schema/filter"
                page:
                  type: integer
                  description: Page number (1-based indexing)
                  minimum: 1
                  default: 1
                  examples: [1]
                limit:
                  type: integer
                  description: Number of results per page
                  minimum: 1
                  maximum: 100
                  default: 20
                  examples: [20]
      responses:
        "200":
          description: Successfully retrieved filtered metadata
          content:
            application/json:
              schema:
                type: object
                required:
                  - metadata
                  - pagination
                properties:
                  metadata:
                    type: array
                    description: List of metadata objects
                    items:
                      $ref: "https://pecha-backend.web.app/schema/metadata"
                  pagination:
                    type: object
                    required:
                      - page
                      - limit
                      - total
                      - pages
                    properties:
                      page:
                        type: integer
                        description: Current page number
                        examples: [1]
                      limit:
                        type: integer
                        description: Number of results per page
                        examples: [20]
                      total:
                        type: integer
                        description: Total number of documents matching the query
                        examples: [42]
                      pages:
                        type: integer
                        description: Total number of pages available
                        examples: [3]
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "500":
          $ref: '#/components/responses/ServerError'
  /schema/filter:
    get:
      summary: Retrieve the Filter Schema
      description: Returns the full JSON schema definition for filter validation.
      tags:
        - Schema
      responses:
        "200":
          description: Successfully retrieved the filter schema.
          content:
            application/json:
              schema:
                type: object
                description: The full JSON schema definition.
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'
  /schema/metadata:
    get:
      summary: Retrieve the Metadata Schema
      description: Returns the full JSON schema definition for metadata validation.
      tags:
        - Schema
      responses:
        "200":
          description: Successfully retrieved the metadata schema.
          content:
            application/json:
              schema:
                type: object
                description: The full JSON schema definition.
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'
  /api/version:
      get:
        summary: Get API version and Git SHA
        description: Returns the current API version and the Git commit SHA of the deployed code.
        operationId: getVersion
        tags:
            - API
        responses:
            "200":
              description: Successfully retrieved version information
              content:
                application/json:
                  schema:
                    type: object
                    properties:
                      version:
                          type: string
                          examples: 
                            - "0.1.0"
                      git_sha:
                          type: string
                          examples:
                            - "b706d2b1a5d0176df374da25c970274b2e0f7770"
            "500":
              $ref: '#/components/responses/ServerError'
  /text/{pecha_id}:
    put:
      summary: Upload a text to update a Pecha
      description: Uploads a docx file and updates the Pecha. The Pecha is re-parsed.
      operationId: putText
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha that is being updated.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                docx:
                  type: string
                  format: binary
                  description: The docx file containing the updated Pecha content.
            examples:
              valid_docx:
                summary: Valid docx file upload
                description: A valid docx file to update a Pecha.
                value:
                  docx: (binary content of a DOCX file)
      responses:
        "201":
          description: Successfully updated the Pecha.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - Pecha updated successfully
                  id:
                    type: string
                    examples:
                      - I857977C3
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'
  /categories:
    get:
      summary: Get category tree
      description: Returns all categories in a hierarchical tree structure
      operationId: getCategories
      tags:
        - Category
      responses:
        '200':
          description: Category tree retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - categories
                properties:
                  categories:
                    type: array
                    items:
                      type: object
                      required:
                        - id
                        - name
                      properties:
                        id:
                          type: string
                        name:
                          type: object
                          additionalProperties:
                            type: string
                        description:
                          type: object
                          additionalProperties:
                            type: string
                        short_description:
                          type: object
                          additionalProperties:
                            type: string
                        subcategories:
                          type: array
                          items:
                            type: object
              examples:
                success:
                  summary: Category tree with nested subcategories
                  value:
                    categories:
                      - id: madhyamaka
                        name:
                          en: "Madhyamaka"
                          bo: "དབུ་མ།"
                        description:
                          en: "Madhyamaka treatises"
                          bo: "དབུ་མའི་གཞུང་སྣ་ཚོགས།"
                        short_description:
                          en: ""
                          bo: ""
                        subcategories:
                          - id: prasangika
                            name:
                              en: "Prasangika"
                              bo: "ཐལ་འགྱུར་བ།"
                            description:
                              en: "Prasangika treatises"
                              bo: "ཐལ་འགྱུར་པའི་གཞུང་སྣ་ཚོགས།"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "500":
          $ref: '#/components/responses/ServerError'

    put:
      summary: Upload categories
      description: Upload a YAML file containing category definitions
      operationId: uploadCategories
      tags:
        - Category
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  description: YAML file containing category definitions
      responses:
        '201':
          description: Categories uploaded successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - count
                properties:
                  message:
                    type: string
                  count:
                    type: integer
              examples:
                success:
                  summary: Categories uploaded successfully
                  value:
                    message: "Categories uploaded successfully"
                    count: 3
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "500":
          $ref: '#/components/responses/ServerError'
components:
  responses:
    InvalidRequest:
      description: There was an error with the request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "There was an error with the request"
            required:
              - error
      
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "Resource was not found"
            required:
              - error
  
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: array
                items:
                  type: object
                  properties:
                    loc:
                      type: array
                      items:
                        type: string
                    msg:
                      type: string
                    type:
                      type: string
            required:
              - error
              - details
          examples:
            fieldMissing:
              value:
                error: "Validation error"
                details: [
                  {
                    "loc": ["body", "title"],
                    "msg": "field required", 
                    "type": "value_error.missing"
                  }
                ]

    ConflictError:
      description: Conflicting data
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "There was a conflict with the resource"
            required:
              - error

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "There was an error on the server"
            required:
              - error
  