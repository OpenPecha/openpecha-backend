openapi: '3.1.0'
info:
  title: OpenPecha API v2
  version: '2.1.0'
servers:
  - url: http://127.0.0.1:5001/pecha-backend-dev/us-central1/api
    description: Local Development
  - url: https://api-l25bgmwqoa-uc.a.run.app
    description: Development
  - url: https://api-aq25662yyq-uc.a.run.app
    description: Production

paths:
  /v2/instances/{instance_id}:
    get:
      summary: Retrieve instance by instance ID
      description: Fetch instance content for a given instance ID. Optionally include non-alignment annotations using the 'annotation' query parameter.
      tags:
        - Instances
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the instance to retrieve
        - name: annotation
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Whether to include annotations (alignment annotations are excluded)
      responses:
        "200":
          description: Instance retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
                  metadata:
                    type: object
                    properties:
                      id:
                        type: string
                      type:
                        type: string
                        enum: [diplomatic, critical]
                      copyright:
                        type: string
                        enum: [public, copyrighted]
                      bdrc:
                        type: string
                      wiki:
                        type: string
                      colophon:
                        type: string
                      incipit_title:
                        type: object
                        additionalProperties:
                          type: string
                      alt_incipit_titles:
                        type: array
                        items:
                          type: object
                          additionalProperties:
                            type: string
                  annotations:
                    type: array
                    items:
                      type: object
                      properties:
                        annotation_id:
                          type: string
                        type:
                          type: string
                          enum: [segmentation, version]
              examples:
                success:
                  summary: Instance with metadata and optional annotations
                  value:
                    content: "This is the base text content"
                    metadata:
                      id: "I12345678"
                      type: "critical"
                      copyright: "public"
                      bdrc: "W123456"
                      wiki: "Q123456"
                      colophon: "colophon text"
                      incipit_title:
                        en: "English incipit title"
                        bo: "Tibetan incipit title"
                      alt_incipit_titles:
                        - en: "Alt title 1"
                        - bo: "Alt title 2"
                    annotations:
                      - annotation_id: "A12345678"
                        type: "segmentation"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/instances/{instance_id}/segment_related:
    get:
      summary: Find related segments or spans for an instance
      description: >-
        Exactly one of `segment_id` or (`span_start` and `span_end`) must be provided.
        - If `segment_id` is provided, returns related segments across manifestations.
        - If `span_start` and `span_end` are provided, returns manifestations with merged spans overlapping the given range.
        - If both are provided, `segment_id` takes precedence.
      tags:
        - Instances
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the instance to search within (used when querying by span)
        - name: segment_id
          in: query
          required: false
          schema:
            type: string
          description: Segment ID to find related segments across other manifestations
        - name: span_start
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Inclusive start offset when searching by span
        - name: span_end
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: Exclusive end offset (must be greater than span_start)
        - name: transfer
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Whether to transfer alignments to segmentation layer. If false (default), returns alignment annotation segments. If true, returns segmentation annotation segments.
      responses:
        "200":
          description: Related items retrieved successfully
          content:
            application/json:
              schema:
                type: array
                description: List of related manifestations with their segments. Same format for both transfer modes - only segment source differs (alignment vs segmentation annotation).
                items:
                  type: object
                  required: [text, instance, segments]
                  properties:
                    text:
                      type: object
                      description: Expression (text) metadata
                      additionalProperties: true
                    instance:
                      type: object
                      description: Manifestation (instance) metadata
                      additionalProperties: true
                    segments:
                      type: array
                      description: Segments from alignment annotation (transfer=false) or segmentation annotation (transfer=true)
                      items:
                        type: object
                        required: [id, span]
                        properties:
                          id:
                            type: string
                            description: Segment ID
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Inclusive start offset
                              end:
                                type: integer
                                minimum: 1
                                description: Exclusive end offset
              examples:
                withoutTransfer:
                  summary: Related segments without transfer (alignment annotation)
                  value:
                    - text:
                        id: "E123"
                        type: "translation"
                        language: "en"
                        title: { en: "English Translation" }
                      instance:
                        id: "I456"
                        type: "critical"
                        copyright: "public"
                      segments:
                        - id: "SEG789"
                          span: { start: 50, end: 90 }
                        - id: "SEG790"
                          span: { start: 90, end: 120 }
                withTransfer:
                  summary: Related segments with transfer (segmentation annotation)
                  value:
                    - text:
                        id: "E123"
                        type: "translation"
                        language: "en"
                        title: { en: "English Translation" }
                      instance:
                        id: "I456"
                        type: "critical"
                        copyright: "public"
                      segments:
                        - id: "SEG_S101"
                          span: { start: 50, end: 75 }
                        - id: "SEG_S102"
                          span: { start: 75, end: 100 }
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                missing_params:
                  summary: Neither segment_id nor span provided
                  value:
                    error: "No segment ID or span provided"
                segment_mismatch:
                  summary: Segment does not belong to manifestation
                  value:
                    error: "Segment SEG123 does not belong to manifestation M456"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                no_segments:
                  summary: No segments found for span
                  value:
                    error: "No segments found containing span [0, 100) in instance 'I12345678'"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                span_minimum:
                  summary: Invalid span values
                  value:
                    error: "Input should be greater than or equal to 0"
                invalid_span_type:
                  summary: Invalid span type in SegmentModel
                  value:
                    error: "Input should be a valid dictionary or instance of SpanModel"
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/instances/{instance_id}/related:
    get:
      summary: Find related texts
      description: Find all related texts, instances and their aligned segments for a given character span in an instance
      tags:
        - Instances
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the instance to find related texts for
        - name: span_start
          in: query
          required: true
          schema:
            type: integer
            minimum: 0
          description: Start character position of the span
        - name: span_end
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
          description: End character position of the span (exclusive, must be greater than start)
      responses:
        "200":
          description: Related texts retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  targets:
                    type: array
                    description: Texts that the selected segments point to
                    items:
                      type: object
                      properties:
                        instance:
                          type: object
                          description: Manifestation details
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                              enum: [diplomatic, critical, collated]
                            copyright:
                              type: string
                              enum: [public, copyrighted]
                            bdrc:
                              type: string
                            wiki:
                              type: string
                            colophon:
                              type: string
                            incipit_title:
                              type: object
                              additionalProperties:
                                type: string
                            alt_incipit_titles:
                              type: array
                              items:
                                type: object
                                additionalProperties:
                                  type: string
                            annotations:
                              type: array
                              items:
                                type: object
                        text:
                          type: object
                          description: Expression (text) details
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                              enum: [root, commentary, translation]
                            title:
                              type: object
                              additionalProperties:
                                type: string
                            language:
                              type: string
                              enum: [en, bo, zh, sa]
                            contributions:
                              type: array
                              items:
                                type: object
                            date:
                              type: string
                            bdrc:
                              type: string
                            wiki:
                              type: string
                            target:
                              type: string
                        spans:
                          type: array
                          description: Merged character spans from aligned segments
                          items:
                            type: object
                            properties:
                              start:
                                type: integer
                              end:
                                type: integer
                  sources:
                    type: array
                    description: Texts whose segments point to the selected segments
                    items:
                      type: object
                      properties:
                        instance:
                          type: object
                          description: Manifestation details
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                              enum: [diplomatic, critical, collated]
                            copyright:
                              type: string
                              enum: [public, copyrighted]
                            bdrc:
                              type: string
                            wiki:
                              type: string
                            colophon:
                              type: string
                            incipit_title:
                              type: object
                              additionalProperties:
                                type: string
                            alt_incipit_titles:
                              type: array
                              items:
                                type: object
                                additionalProperties:
                                  type: string
                            annotations:
                              type: array
                              items:
                                type: object
                        text:
                          type: object
                          description: Expression (text) details
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                              enum: [root, commentary, translation]
                            title:
                              type: object
                              additionalProperties:
                                type: string
                            language:
                              type: string
                              enum: [en, bo, zh, sa]
                            contributions:
                              type: array
                              items:
                                type: object
                            date:
                              type: string
                            bdrc:
                              type: string
                            wiki:
                              type: string
                            target:
                              type: string
                        spans:
                          type: array
                          description: Merged character spans from aligned segments
                          items:
                            type: object
                            properties:
                              start:
                                type: integer
                              end:
                                type: integer
              examples:
                success:
                  summary: Related texts with merged spans separated by direction
                  value:
                    targets:
                      - instance:
                          id: "I87654321"
                          type: "diplomatic"
                          copyright: "public"
                          bdrc: "W789012"
                        text:
                          id: "T87654321"
                          type: "translation"
                          title:
                            en: "English Translation"
                          language: "en"
                          target: "T12345678"
                        spans:
                          - start: 0
                            end: 150
                          - start: 200
                            end: 350
                    sources:
                      - instance:
                          id: "I11111111"
                          type: "critical"
                          copyright: "public"
                        text:
                          id: "T11111111"
                          type: "root"
                          title:
                            bo: "མ་ཕྱི།"
                          language: "bo"
                        spans:
                          - start: 50
                            end: 100
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                missing_params:
                  summary: Missing parameters
                  value:
                    error: "Both 'start' and 'end' query parameters are required"
                invalid_integers:
                  summary: Invalid parameter types
                  value:
                    error: "'start' and 'end' must be valid integers"
                invalid_span:
                  summary: Invalid span range
                  value:
                    error: "Invalid span: 'start' must be >= 0, 'end' must be > start"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                no_segments:
                  summary: No segments found
                  value:
                    error: "No segments found containing span [0, 100) in instance 'I12345678'"
        "500":
          $ref: '#/components/responses/ServerError'
  /v2/instances/{instance_id}/segment-content:
    get:
      summary: Get text content (unified endpoint)
      description: |
        Unified endpoint to retrieve text content from either:
        1. A specific segment using segment_id parameter (within the given instance)
        2. An instance excerpt using span_start and span_end parameters
        
        **Validation constraints:**
        - If segment_id is provided: cannot use span_start or span_end parameters
        - If using span approach: must provide span_start and span_end, cannot use segment_id
        - Must provide either segment_id OR span_start and span_end (mutually exclusive)
      tags:
        - Instances
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the instance to retrieve content from
        - name: segment_id
          in: query
          required: false
          schema:
            type: string
          description: The ID of the segment to retrieve content for (alternative to span approach)
        - name: span_start
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Start character position of the excerpt (required when using span approach)
        - name: span_end
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: End character position of the excerpt (required when using span approach)
      responses:
        "200":
          description: Text content retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
                    description: The extracted text content
              examples:
                segment_content:
                  summary: Content retrieved by segment ID
                  value:
                    content: "This is the text content of the segment."
                manifestation_excerpt:
                  summary: Content retrieved by manifestation span
                  value:
                    content: "This is the text content from the specified span."
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Error message
              examples:
                missing_parameters:
                  summary: Neither segment_id nor span parameters provided
                  value:
                    error: "Either segment_id OR span_start and span_end is required"
                conflicting_parameters:
                  summary: Both segment_id and span parameters provided
                  value:
                    error: "Cannot provide both segment_id and span parameters. Use one approach only."
                segment_with_span:
                  summary: Segment approach with span parameters
                  value:
                    error: "When using segment_id, do not provide span_start or span_end parameters."
                missing_span:
                  summary: Missing span parameters for span approach
                  value:
                    error: "span_start and span_end parameters are required when using span approach"
                invalid_span:
                  summary: Invalid span parameters (handled by SpanModel)
                  value:
                    error: "Invalid span parameters: 'start' must be less than 'end'"
                segment_span_exceeds:
                  summary: Segment span exceeds text length
                  value:
                    error: "segment span end (1000) exceeds base text length (500)"
                instance_span_exceeds:
                  summary: Instance span exceeds text length
                  value:
                    error: "span end (1000) exceeds base text length (500)"
        "404":
          description: Resource not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Error message
              examples:
                segment_not_found:
                  summary: Segment not found
                  value:
                    error: "Failed to retrieve segment content: Segment with ID 'SEG123' not found"
                instance_not_found:
                  summary: Instance not found
                  value:
                    error: "Failed to retrieve instance content: Instance with ID 'INST123' not found"
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/instances/{instance_id}/excerpt:
    get:
      summary: Get text excerpt
      description: Retrieve a specific excerpt (substring) of the base text content for a given instance based on character span
      tags:
        - Instances
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the instance to retrieve excerpt from
        - name: span_start
          in: query
          required: true
          schema:
            type: integer
            minimum: 0
          description: Start character position of the excerpt (inclusive)
        - name: span_end
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
          description: End character position of the excerpt (exclusive, must be greater than span_start)
      responses:
        "200":
          description: Excerpt retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  excerpt:
                    type: string
                    description: The extracted text content from the specified character span
              examples:
                success:
                  summary: Excerpt from position 2 to 4
                  value:
                    excerpt: "hj"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                missing_params:
                  summary: Missing required parameters
                  value:
                    error: "Both 'span_start' and 'span_end' query parameters are required"
                invalid_span:
                  summary: Invalid span range
                  value:
                    error: "Invalid span: 'span_start' must be >= 0, 'span_end' must be > span_start"
                span_exceeds:
                  summary: Span exceeds text length
                  value:
                    error: "span_end (1000) exceeds base text length (500)"
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/texts/{text_id}/instances:
    get:
      summary: Get instances for text
      description: Retrieve all instances associated with a text. Optionally filter by instance type (manifestation type).
      tags:
        - Instances
      parameters:
        - name: text_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the text
        - name: instance_type
          in: query
          required: false
          schema:
            type: string
            enum: [diplomatic, critical, all]
            default: all
          description: Filter instances by type. Use 'diplomatic' for diplomatic editions, 'critical' for critical editions, or 'all' to retrieve all types (default).
      responses:
        "200":
          description: Instances retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    type:
                      type: string
                      enum: [diplomatic, critical]
                    copyright:
                      type: string
                      enum: [public, copyrighted]
                    bdrc:
                      type: string
                    wiki:
                      type: string
                    colophon:
                      type: string
                    incipit_title:
                      type: object
                      additionalProperties:
                        type: string
                    alt_incipit_titles:
                      type: array
                      items:
                        type: object
                        additionalProperties:
                          type: string
              examples:
                success:
                  summary: List of instances
                  value:
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      copyright: "public"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "diplomatic"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      copyright: "public"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "diplomatic"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      copyright: "public"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "diplomatic"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      copyright: "public"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "diplomatic"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      copyright: "public"
                      incipit_title:
                        bo: "དབུ་ཚིག"
                        en: "Opening words"
                      type: "critical"
                      wiki: null
                    - alt_incipit_titles: []
                      bdrc: "W123456"
                      colophon: "Sample colophon text"
                      copyright: "public"
                      incipit_title: null
                      type: "diplomatic"
                      wiki: null
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'

    post:
      summary: Create a new instance
      description: Create a new instance with metadata for a specific text
      tags:
        - Instances
      parameters:
        - name: text_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the text to create an instance for
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - metadata
                - content
              properties:
                metadata:
                  type: object
                  required:
                    - type
                  properties:
                    type:
                      type: string
                      enum: [diplomatic, critical]
                      description: Type of manifestation
                    copyright:
                      type: string
                      enum: [public, copyrighted]
                      default: public
                      description: Copyright status
                    bdrc:
                      type: string
                      description: BDRC identifier (required for diplomatic type)
                    wiki:
                      type: string
                      description: Wiki identifier
                    colophon:
                      type: string
                      description: Colophon text
                    incipit_title:
                      type: object
                      additionalProperties:
                        type: string
                      description: Localized incipit title
                    alt_incipit_titles:
                      type: array
                      items:
                        type: object
                        additionalProperties:
                          type: string
                      description: Alternative localized incipit titles
                annotation:
                  type: array
                  items:
                    oneOf:
                      - type: object
                        required: [span]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                        description: Segmentation annotation (for CRITICAL manifestations)
                      - type: object
                        required: [span, reference]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                          reference:
                            type: string
                            description: Page/folio reference for the span
                        description: Pagination annotation (for DIPLOMATIC manifestations)
                  description: Segmentation or pagination annotation segments
                biblography_annotation:
                  type: array
                  items:
                    type: object
                    required: [span, biblography_type]
                    properties:
                      span:
                        type: object
                        required: [start, end]
                        properties:
                          start:
                            type: integer
                            minimum: 0
                            description: Start character position (inclusive)
                          end:
                            type: integer
                            minimum: 1
                            description: End character position (exclusive)
                      biblography_type:
                        type: string
                        description: Type of bibliography annotation
                  description: Bibliography annotation segments with bibliography type
                content:
                  type: string
                  description: The text content
            examples:
              valid_diplomatic_instance_with_annotation:
                summary: Valid diplomatic instance creation with annotation
                value:
                  metadata:
                    type: "diplomatic"
                    copyright: "public"
                    bdrc: "W123456"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  annotation:
                    - span:
                        start: 0
                        end: 10
                      reference: "https://example.com/image1.png"
                    - span:
                        start: 11
                        end: 20
                      reference: "https://example.com/image2.png"
                  content: "This is the text content to be stored"     
              valid_critical_instance_with_annotation:
                summary: Valid critical instance creation with annotation
                value:
                  metadata:
                    type: "critical"
                    copyright: "public"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  annotation:
                    - span:
                        start: 0
                        end: 10
                    - span:
                        start: 10
                        end: 20
                  content: "This is the text content to be stored"           
              valid_critical_instance_without_annotation:
                summary: Valid critical instance creation without annotation
                value:
                  metadata:
                    type: "critical"
                    copyright: "public"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  content: "This is the text content to be stored"          
              valid_diplomatic_instance_without_annotation:
                summary: Valid diplomatic instance creation without annotation
                value:
                  metadata:
                    type: "diplomatic"
                    copyright: "public"
                    bdrc: "W123456"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  content: "This is the text content to be stored"
              valid_instance_with_bibliography_annotation:
                summary: Valid instance creation with bibliography annotation
                value:
                  metadata:
                    type: "critical"
                    copyright: "public"
                    colophon: "Sample colophon text"
                    incipit_title:
                      en: "Opening words"
                      bo: "དབུ་ཚིག"
                  annotation:
                    - span:
                        start: 0
                        end: 10
                    - span:
                        start: 10
                        end: 20
                  biblography_annotation:
                    - span:
                        start: 5
                        end: 15
                      biblography_type: "citation"
                    - span:
                        start: 20
                        end: 30
                      biblography_type: "reference"
                  content: "This is the text content to be stored"                           
      responses:
        "201":
          description: Instance created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - "Instance created successfully"
                  id:
                    type: string
                    examples:
                      - "ABC12345678"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/instances/{instance_id}/translation:
    post:
      summary: Create a translation
      description: Create a translation of an existing instance
      tags:
        - Instances
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the original instance to translate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - language
                - content
                - title
                - segmentation
              properties:
                language:
                  type: string
                  enum: [en, bo, zh, sa]
                  description: Target language code
                content:
                  type: string
                  description: The translated text content
                title:
                  type: string
                  description: Title of the translation
                alt_titles:
                  type: array
                  items:
                    type: string
                author:
                  type: object
                  properties:
                    person_id:
                      type: string
                    person_bdrc_id:
                      type: string
                    ai_id:
                      type: string
                  description: Creator of the translation (optional)
                segmentation:
                  type: array
                  items:
                    type: object
                  description: Segmentation annotation for translation (required)
                alignment_annotation:
                  type: array
                  items:
                    type: object
                  description: Alignment annotation for translation (optional, must be provided together with target_annotation)
                target_annotation:
                  type: array
                  items:
                    type: object
                  description: Alignment annotation for original text (optional, must be provided together with alignment_annotation)
                copyright:
                  type: string
                  enum: [public, copyrighted]
                  default: public
            examples:
              valid_translation_with_alignment_annotation:
                summary: Valid translation creation request with alignment annotation
                value:
                  language: "en"
                  content: "This is the translated text content"
                  title: "Translated Title"
                  author:
                    person_id: "P12345678"
                  segmentation:
                    - span:
                        start: 0
                        end: 20
                    - span:
                        start: 21
                        end: 40
                  target_annotation:
                    - span:
                        start: 0
                        end: 20
                      index: 0
                    - span:
                        start: 21
                        end: 40
                      index: 1
                  alignment_annotation:
                    - span:
                        start: 0
                        end: 20
                      index: 0
                      alignment_index: [0]
                    - span:
                        start: 21
                        end: 50
                      index: 1
                      alignment_index: [1]
                  copyright: "public"
              valid_translation_without_alignment_annotation:
                summary: Valid translation creation request without alignment annotation
                value:
                  language: "en"
                  content: "This is the translated text content"
                  title: "Translated Title"
                  author:
                    person_id: "P12345678"
                  segmentation:
                    - span:
                        start: 0
                        end: 20
                    - span:
                        start: 21
                        end: 40
                  copyright: "public"    
      responses:
        "201":
          description: Translation created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - "Text created successfully"
                  instance_id:
                    type: string
                    examples:
                      - "ABC12345678"
                  text_id:
                    type: string
                    examples:
                      - "ABC12345678"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/instances/{instance_id}/commentary:
    post:
      summary: Create a commentary
      description: Create a commentary of an existing instance
      tags:
        - Instances
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the original instance to comment on
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - language
                - content
                - title
                - segmentation
              properties:
                language:
                  type: string
                  enum: [en, bo, zh, sa]
                  description: Language code for the commentary
                content:
                  type: string
                  description: The commentary text content
                title:
                  type: string
                  description: Title of the commentary
                alt_titles:
                  type: array
                  items:
                    type: string
                author:
                  type: object
                  properties:
                    person_id:
                      type: string
                    person_bdrc_id:
                      type: string
                segmentation:
                  type: array
                  items:
                    type: object
                  description: Segmentation annotation for commentary (required)
                alignment_annotation:
                  type: array
                  items:
                    type: object
                  description: Alignment annotation for commentary (optional, must be provided together with target_annotation)
                target_annotation:
                  type: array
                  items:
                    type: object
                  description: Alignment annotation for original text (optional, must be provided together with alignment_annotation)
                copyright:
                  type: string
                  enum: [public, copyrighted]
                  default: public
                category_id:
                  type: string
                  nullable: true
                  description: ID of the category this commentary belongs to (optional)
            examples:
              valid_commentary_with_alignment_annotation:
                summary: Valid commentary creation request with alignment annotation
                value:
                  language: "en"
                  content: "This is the commentary text content"
                  title: "Commentary Title"
                  author:
                    person_id: "P12345678"
                  segmentation:
                    - span:
                        start: 0
                        end: 20
                    - span:
                        start: 21
                        end: 40
                  target_annotation:
                    - span:
                        start: 0
                        end: 20
                      index: 0
                    - span:
                        start: 21
                        end: 40
                      index: 1
                    - span:
                        start: 40
                        end: 50
                      index: 2
                  alignment_annotation:
                    - span:
                        start: 0
                        end: 20
                      index: 0
                      alignment_index: [0,1]
                    - span:
                        start: 21
                        end: 50
                      index: 1
                      alignment_index: [1,2]
                  copyright: "public"
                  category_id: "CAT12345678"
              valid_commentary_without_alignment_annotation:
                summary: Valid commentary creation request without alignment annotation
                value:
                  language: "en"
                  content: "This is the commentary text content"
                  title: "Commentary Title"
                  author:
                    person_id: "P12345678"
                  segmentation:
                    - span:
                        start: 0
                        end: 20
                    - span:
                        start: 21
                        end: 40
                  copyright: "public"
                  category_id: "CAT12345678"
      responses:
        "201":
          description: Commentary created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - "Text created successfully"
                  instance_id:
                    type: string
                    examples:
                      - "ABC12345678"
                  text_id:
                    type: string
                    examples:
                      - "ABC12345678"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/texts:
    get:
      summary: Retrieve all texts
      description: Fetch all texts with optional filtering and pagination
      tags:
        - Texts
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of results per page
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [root, commentary, translation]
          description: Filter by text type
        - name: language
          in: query
          required: false
          schema:
            type: string
          description: Filter by language code
        - name: author
          in: query
          required: false
          schema:
            type: string
          description: Filter by author name
      responses:
        "200":
          description: Texts retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    type:
                      type: string
                      enum: [root, commentary, translation]
                    title:
                      type: object
                      additionalProperties:
                        type: string
                    alt_titles:
                      type: array
                      items:
                        type: object
                        additionalProperties:
                          type: string
                    language:
                      type: string
                      enum: [en, bo, zh, sa]
                    contributions:
                      type: array
                      items:
                        type: object
                        properties:
                          person_id:
                            type: string
                          person_bdrc_id:
                            type: string
                          ai_id:
                            type: string
                          role:
                            type: string
                            enum: [author, translator, reviser, scholar]
                    date:
                      type: string
                    bdrc:
                      type: string
                    wiki:
                      type: string
                    target:
                      type: string
              examples:
                success:
                  summary: List of texts
                  value:
                    - id: "ABC12345678"
                      type: "root"
                      title:
                        en: "Sample Expression"
                        bo: "དཔེ་མཚོན་ཚིག་སྒྲུབ།"
                      language: "bo"
                      contributions:
                        - person_id: "P12345678"
                          role: "author"
                      date: "2024-01-01"
                      bdrc: "W123456"
                    - id: "DEF87654321"
                      type: "translation"
                      title:
                        en: "AI Generated Translation"
                      language: "en"
                      contributions:
                        - ai_id: "gpt-4"
                          role: "translator"
                      target: "ABC12345678"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "500":
          $ref: '#/components/responses/ServerError'

    post:
      summary: Create text
      description: Create a new text record
      tags:
        - Texts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - type
                - title
                - language
                - contributions
              properties:
                type:
                  type: string
                  enum: [root, commentary, translation]
                title:
                  type: object
                  additionalProperties:
                    type: string
                  description: Localized title
                alt_titles:
                  type: array
                  items:
                    type: object
                    additionalProperties:
                      type: string
                  description: Alternative localized titles
                language:
                  type: string
                  enum: [en, bo, zh, sa]
                contributions:
                  type: array
                  items:
                    type: object
                    properties:
                      person_id:
                        type: string
                      person_bdrc_id:
                        type: string
                      ai_id:
                        type: string
                      role:
                        type: string
                        enum: [author, translator, reviser, scholar]
                date:
                  type: string
                bdrc:
                  type: string
                wiki:
                  type: string
                target:
                  type: string
                  description: Target metadata ID (required for commentary)
                category_id:
                  type: string
                  nullable: true
                  description: ID of the category this text belongs to (optional)
            examples:
              root_text:
                summary: Root text creation
                value:
                  type: "root"
                  title:
                    en: "Sample Root Text"
                    bo: "རྩ་བའི་གཞུང་དཔེ།"
                  language: "bo"
                  contributions:
                    - person_id: "P12345678"
                      role: "author"
                  date: "2024-01-01"
                  bdrc: "W123456"
                  category_id: "CAT12345678"
              translation_text:
                summary: Translation text creation
                value:
                  type: "translation"
                  title:
                    en: "English Translation"
                  language: "en"
                  contributions:
                    - person_bdrc_id: "P87654321"
                      role: "translator"
                  category_id: "CAT12345678"
              ai_translation_text:
                summary: AI translation text creation
                value:
                  type: "translation"
                  title:
                    en: "AI English Translation"
                  language: "en"
                  contributions:
                    - ai_id: "gpt-4"
                      role: "translator"
                  target: "T12345678"
                  category_id: "CAT12345678"
      responses:
        "201":
          description: Text created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - "Text created successfully"
                  id:
                    type: string
                    examples:
                      - "T12345678"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/texts/{text_id}:
    get:
      summary: Retrieve text by ID
      description: Fetch a specific text by its ID
      tags:
        - Texts
      parameters:
        - name: text_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the text to retrieve
      responses:
        "200":
          description: Metadata retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  type:
                    type: string
                    enum: [root, commentary, translation]
                  title:
                    type: object
                    additionalProperties:
                      type: string
                  alt_titles:
                    type: array
                    items:
                      type: object
                      additionalProperties:
                        type: string
                  language:
                    type: string
                    enum: [en, bo, zh, sa]
                  contributions:
                    type: array
                    items:
                      type: object
                      properties:
                        person_id:
                          type: string
                        person_bdrc_id:
                          type: string
                        ai_id:
                          type: string
                        role:
                          type: string
                          enum: [author, translator, reviser, scholar]
                  date:
                    type: string
                  bdrc:
                    type: string
                  wiki:
                    type: string
                  target:
                    type: string
              examples:
                success:
                  summary: Single text
                  value:
                    id: "T12345678"
                    type: "root"
                    title:
                      en: "Sample Expression"
                      bo: "དཔེ་མཚོན་ཚིག་སྒྲུབ།"
                    language: "bo"
                    contributions:
                      - person_id: "P12345678"
                        role: "author"
                    date: "2024-01-01"
                    bdrc: "W123456"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/persons:
    get:
      summary: Retrieve all persons
      description: Fetch all persons from the database with optional pagination
      tags:
        - Persons
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of results per page
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip
      responses:
        "200":
          description: Persons retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: object
                      additionalProperties:
                        type: string
                    alt_names:
                      type: array
                      items:
                        type: object
                        additionalProperties:
                          type: string
                    bdrc:
                      type: string
                    wiki:
                      type: string
              examples:
                success:
                  summary: List of persons
                  value:
                    - id: "P12345678"
                      name:
                        en: "John Doe"
                        bo: "ཇོན་དོ།"
                      alt_names:
                        - en: "J. Doe"
                          bo: "ཇོན།"
                      bdrc: "P123456"
                      wiki: "Q123456"
        "500":
          $ref: '#/components/responses/ServerError'

    post:
      summary: Create a person
      description: Create a new person record
      tags:
        - Persons
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: object
                  additionalProperties:
                    type: string
                  description: Localized name
                alt_names:
                  type: array
                  items:
                    type: object
                    additionalProperties:
                      type: string
                  description: Alternative localized names
                bdrc:
                  type: string
                  description: BDRC identifier
                wiki:
                  type: string
                  description: Wikidata identifier
            examples:
              valid_person:
                summary: Valid person creation
                value:
                  name:
                    en: "John Doe"
                    bo: "ཇོན་དོ།"
                  alt_names:
                    - en: "J. Doe"
                      bo: "ཇོན།"
                  bdrc: "P123456"
                  wiki: "Q123456"
      responses:
        "201":
          description: Person created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - "Person created successfully"
                  _id:
                    type: string
                    examples:
                      - "P12345678"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/persons/{person_id}:
    get:
      summary: Retrieve person by ID
      description: Fetch a specific person by their ID
      tags:
        - Persons
      parameters:
        - name: person_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the person to retrieve
      responses:
        "200":
          description: Person retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: object
                    additionalProperties:
                      type: string
                  alt_names:
                    type: array
                    items:
                      type: object
                      additionalProperties:
                        type: string
                  bdrc:
                    type: string
                  wiki:
                    type: string
              examples:
                success:
                  summary: Single person
                  value:
                    id: "P12345678"
                    name:
                      en: "John Doe"
                      bo: "ཇོན་དོ།"
                    alt_names:
                      - en: "J. Doe"
                        bo: "ཇོན།"
                    bdrc: "P123456"
                    wiki: "Q123456"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/annotations/{annotation_id}:
    get:
      summary: Retrieve annotation by ID
      description: Fetch a specific annotation by its ID including all segments
      tags:
        - Annotations
      parameters:
        - name: annotation_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the annotation to retrieve
      responses:
        "200":
          description: Annotation retrieved successfully
          content:
            application/json:
              schema:
                type: object
                description: Annotation data with uniform structure containing all possible keys
                required:
                  - annotation
                  - alignment_annotation
                  - target_annotation
                properties:
                  annotation:
                    oneOf:
                      - type: array
                        description: Segmentation or pagination annotation segments
                        items:
                          type: object
                          required:
                            - id
                            - span
                          properties:
                            id:
                              type: string
                              description: Unique identifier for the segment
                            span:
                              type: object
                              description: Character span of the segment
                              required:
                                - start
                                - end
                              properties:
                                start:
                                  type: integer
                                  description: Start character position 
                                end:
                                  type: integer
                                  description: End character position
                            reference:
                              type: string
                              nullable: true
                              description: Image ID this annotation is referring to 
                      - type: 'null'
                        description: No segmentation/pagination annotation data (not applicable for alignment)
                  alignment_annotation:
                    oneOf:
                      - type: array
                        description: Alignment annotation source segments with alignment mappings
                        items:
                          type: object
                          required:
                            - id
                            - span
                            - index
                            - alignment_index
                          properties:
                            id:
                              type: string
                              description: Unique identifier for the segment
                            span:
                              type: object
                              description: Character span of the segment
                              required:
                                - start
                                - end
                              properties:
                                start:
                                  type: integer
                                  description: Start character position 
                                end:
                                  type: integer
                                  description: End character position
                            index:
                              type: integer
                              description: Index of the segment
                            alignment_index:
                              type: array
                              items:
                                type: integer
                              description: Array of target segment indices this segment aligns to
                      - type: 'null'
                        description: No alignment annotation data (not applicable for segmentation/pagination)
                  target_annotation:
                    oneOf:
                      - type: array
                        description: Target annotation segments for alignment annotations
                        items:
                          type: object
                          required:
                            - id
                            - span
                            - index
                          properties:
                            id:
                              type: string
                              description: Unique identifier for the segment
                            span:
                              type: object
                              description: Character span of the segment
                              required:
                                - start
                                - end
                              properties:
                                start:
                                  type: integer
                                  description: Start character position 
                                end:
                                  type: integer
                                  description: End character position
                            index:
                              type: integer
                              description: Index of the segment 
                      - type: 'null'
                        description: No target annotation (not applicable for segmentation/pagination) 
              examples:
                segmentation annotation:
                  summary: Segmentation annotation with segments
                  value:
                    annotation:
                      - id: "sdlsakdf"
                        span:
                          start: 0
                          end: 20
                      - id: "akjdlks"
                        span:
                          start: 20
                          end: 45
                    alignment_annotation: null
                    target_annotation: null
                pagination annotation:
                  summary: Pagination annotation with segments and reference
                  value:
                    annotation:
                      - id: "laksdfklsjd"
                        span:
                          start: 0
                          end: 25
                        reference: "IMG001.png"
                      - id: "aksdfnjksdf"
                        span:
                          start: 25
                          end: 50
                        reference: "IMG002.png"
                    alignment_annotation: null
                    target_annotation: null
                alignment annotation:
                  summary: Alignment annotation with segments and alignment mappings
                  value:
                    annotation: null
                    alignment_annotation:
                      - id: "idx6tTeELJEwEQiIEyqhQ"
                        span:
                          start: 0
                          end: 1
                        index: 0
                        alignment_index: [0, 1]
                      - id: "NB9oPpSDymL33ZhYYE9xs"
                        span:
                          start: 1
                          end: 2
                        index: 1
                        alignment_index: [1, 2]
                      - id: "Texrsipn60lEZWQJKFH3y"
                        span:
                          start: 2
                          end: 3
                        index: 2
                        alignment_index: [3]
                      - id: "Ah5AIixdu5svKBynmUOhg"
                        span:
                          start: 3
                          end: 4
                        index: 3
                        alignment_index: [3, 4]
                    target_annotation:
                      - id: "vYnN5yiwBXvA4MJdUtDqz"
                        span:
                          start: 0
                          end: 1
                        index: 0
                      - id: "nDMQBXVRvuKfbRbO96qIM"
                        span:
                          start: 1
                          end: 2
                        index: 1
                      - id: "mqOyBwAGdfNwXMQMef4XF"
                        span:
                          start: 2
                          end: 3
                        index: 2
                      - id: "pMBGOZp4dxOWIEjAAlnWe"
                        span:
                          start: 3
                          end: 4
                        index: 3
                      - id: "AWLRjvyTbTtbMXVysSsr6"
                        span:
                          start: 4
                          end: 5
                        index: 4
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/annotations/{manifestation_id}/annotation:
    post:
      summary: Add annotation to a manifestation
      description: >-
        Adds an annotation to the specified manifestation. Supports multiple annotation types:
        - SEGMENTATION: For CRITICAL manifestations, send segmentation annotations (span only).
          For DIPLOMATIC manifestations, send pagination annotations (span + reference).
        - PAGINATION: Send pagination annotations with span and reference (for DIPLOMATIC manifestations).
        - BIBLIOGRAPHY: Send bibliography annotations with span and bibliography type.
        - ALIGNMENT: Creates alignment relationships between segments of the source and target manifestations.
      tags:
        - Annotations
      parameters:
        - name: manifestation_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the manifestation to annotate (source manifestation for ALIGNMENT type)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - annotation_type
              properties:
                annotation_type:
                  type: string
                  enum: [segmentation, alignment, pagination, bibliography]
                  description: Type of annotation to add
                annotation:
                  type: array
                  minItems: 1
                  description: Array of segmentation, pagination, or bibliography annotations (required for SEGMENTATION, PAGINATION, or BIBLIOGRAPHY type)
                  items:
                    oneOf:
                      - type: object
                        required: [span]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                        description: Segmentation annotation (for CRITICAL manifestations)
                      - type: object
                        required: [span, reference]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                          reference:
                            type: string
                            description: Page/folio reference for the span
                        description: Pagination annotation (for DIPLOMATIC manifestations)
                      - type: object
                        required: [span, biblography_type]
                        properties:
                          span:
                            type: object
                            required: [start, end]
                            properties:
                              start:
                                type: integer
                                minimum: 0
                                description: Start character position (inclusive)
                              end:
                                type: integer
                                minimum: 1
                                description: End character position (exclusive)
                          biblography_type:
                            type: string
                            description: Type of bibliography annotation
                        description: Bibliography annotation
                target_manifestation_id:
                  type: string
                  description: Target manifestation ID (required for ALIGNMENT type)
                target_annotation:
                  type: array
                  minItems: 1
                  description: Array of alignment annotations for target manifestation (required for ALIGNMENT type)
                  items:
                    type: object
                    required: [span, index, alignment_index]
                    properties:
                      span:
                        type: object
                        required: [start, end]
                        properties:
                          start:
                            type: integer
                            minimum: 0
                            description: Start character position (inclusive)
                          end:
                            type: integer
                            minimum: 1
                            description: End character position (exclusive)
                      index:
                        type: integer
                        description: Index of the segment in the target annotation
                alignment_annotation:
                  type: array
                  minItems: 1
                  description: Array of alignment annotations for source manifestation (required for ALIGNMENT type)
                  items:
                    type: object
                    required: [span, index, alignment_index]
                    properties:
                      span:
                        type: object
                        required: [start, end]
                        properties:
                          start:
                            type: integer
                            minimum: 0
                            description: Start character position (inclusive)
                          end:
                            type: integer
                            minimum: 1
                            description: End character position (exclusive)
                      index:
                        type: integer
                        description: Index of the segment in the alignment annotation
                      alignment_index:
                        type: array
                        items:
                          type: integer
                        description: List of indices in target_annotation that this segment aligns to
            examples:
              segmentation_critical:
                summary: Segmentation annotations (CRITICAL manifestation)
                value:
                  annotation_type: segmentation
                  annotation:
                    - span:
                        start: 0
                        end: 42
                    - span:
                        start: 42
                        end: 100
              segmentation_diplomatic:
                summary: Pagination annotations (DIPLOMATIC manifestation)
                value:
                  annotation_type: segmentation
                  annotation:
                    - span:
                        start: 0
                        end: 42
                      reference: "folio 1a"
                    - span:
                        start: 42
                        end: 100
                      reference: "folio 1b"
              bibliography:
                summary: Bibliography annotations
                value:
                  annotation_type: bibliography
                  annotation:
                    - span:
                        start: 0
                        end: 50
                      biblography_type: "citation"
                    - span:
                        start: 50
                        end: 100
                      biblography_type: "reference"
              alignment:
                summary: Alignment annotations
                value:
                  annotation_type: alignment
                  target_manifestation_id: "MNF12345678"
                  target_annotation:
                    - span:
                        start: 0
                        end: 50
                      index: 0
                    - span:
                        start: 50
                        end: 100
                      index: 1
                  alignment_annotation:
                    - span:
                        start: 0
                        end: 30
                      index: 0
                      alignment_index: [0]
                    - span:
                        start: 30
                        end: 60
                      index: 1
                      alignment_index: [0, 1]
                    - span:
                        start: 60
                        end: 100
                      index: 2
                      alignment_index: [1]
      responses:
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                body_required:
                  summary: Missing request body
                  value:
                    error: "Request body is required"
                invalid_annotation_type:
                  summary: Invalid annotation type
                  value:
                    error: "Invalid annotation type. Allowed types are [SEGMENTATION, ALIGNMENT]"
                missing_annotation:
                  summary: Missing annotation data
                  value:
                    error: "Segmentation annotation cannot be empty"
                missing_target_manifestation:
                  summary: Missing target manifestation ID
                  value:
                    error: "Target manifestation id must be provided"
                missing_alignment_annotations:
                  summary: Missing alignment annotations
                  value:
                    error: "Both target annotation and alignment annotation must be provided"
        "201":
          description: Annotation added successfully
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    required: [message, annotation_id]
                    properties:
                      message:
                        type: string
                      annotation_id:
                        type: string
                    description: Response for SEGMENTATION type
                  - type: object
                    required: [message, alignment_annotation_id, target_annotation_id]
                    properties:
                      message:
                        type: string
                      alignment_annotation_id:
                        type: string
                      target_annotation_id:
                        type: string
                    description: Response for ALIGNMENT type
              examples:
                segmentation:
                  summary: Segmentation annotation response
                  value:
                    message: "Annotation added successfully"
                    annotation_id: "A12345678"
                alignment:
                  summary: Alignment annotation response
                  value:
                    message: "Alignment annotation added successfully"
                    alignment_annotation_id: "A12345678"
                    target_annotation_id: "A87654321"
        "404":
          $ref: '#/components/responses/NotFound'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/segments/{segment_id}/related:
    get:
      summary: Find related texts for a segment
      description: Find all related texts and instances that are aligned to a specific segment
      tags:
        - Segments
      parameters:
        - name: segment_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the segment to find related texts for
      responses:
        "200":
          description: Related texts retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  targets:
                    type: array
                    description: Texts that this segment points to (outgoing alignments)
                    items:
                      type: object
                      properties:
                        instance:
                          type: object
                          description: Manifestation details
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                              enum: [diplomatic, critical, collated]
                            copyright:
                              type: string
                              enum: [public, copyrighted]
                            bdrc:
                              type: string
                            wiki:
                              type: string
                        text:
                          type: object
                          description: Expression (text) details
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                              enum: [root, commentary, translation]
                            title:
                              type: object
                              additionalProperties:
                                type: string
                            language:
                              type: string
                        segments:
                          type: array
                          description: List of aligned segments with their IDs and spans
                          items:
                            type: object
                            properties:
                              id:
                                type: string
                                description: Segment ID
                              span:
                                type: object
                                properties:
                                  start:
                                    type: integer
                                    description: Start character position
                                  end:
                                    type: integer
                                    description: End character position
                  sources:
                    type: array
                    description: Texts whose segments point to this segment (incoming alignments)
                    items:
                      type: object
                      properties:
                        instance:
                          type: object
                          description: Manifestation details
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                              enum: [diplomatic, critical, collated]
                            copyright:
                              type: string
                              enum: [public, copyrighted]
                            bdrc:
                              type: string
                            wiki:
                              type: string
                        text:
                          type: object
                          description: Expression (text) details
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                              enum: [root, commentary, translation]
                            title:
                              type: object
                              additionalProperties:
                                type: string
                            language:
                              type: string
                        segments:
                          type: array
                          description: List of aligned segments with their IDs and spans
                          items:
                            type: object
                            properties:
                              id:
                                type: string
                                description: Segment ID
                              span:
                                type: object
                                properties:
                                  start:
                                    type: integer
                                    description: Start character position
                                  end:
                                    type: integer
                                    description: End character position
              examples:
                success:
                  summary: Related texts with segments
                  value:
                    targets:
                      - instance:
                          id: "M12345678"
                          type: "critical"
                          copyright: "public"
                        text:
                          id: "E12345678"
                          type: "translation"
                          title:
                            en: "Translation of the Text"
                          language: "en"
                        segments:
                          - id: "SEG001"
                            span:
                              start: 0
                              end: 100
                          - id: "SEG002"
                            span:
                              start: 100
                              end: 200
                    sources: []
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/segments/{segment_id}/content:
    get:
      summary: Get segment text content
      description: Retrieve the base text content for a segment based on its character span
      tags:
        - Segments
      parameters:
        - name: segment_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the segment to retrieve text content for
      responses:
        "200":
          description: Segment content retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
                    description: The text content of the segment
              examples:
                success:
                  summary: Segment text content
                  value:
                    content: "This is the text content of the segment."
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/ServerError'

  /v2/categories:
    get:
      summary: Retrieve categories
      description: Get categories filtered by application and optional parent, with localized names in the requested language
      tags:
        - Categories
      parameters:
        - name: application
          in: query
          required: true
          schema:
            type: string
          description: Application context for categories
          example: "webuddhist"
        - name: parent_id
          in: query
          required: false
          schema:
            type: string
            nullable: true
          description: Parent category ID (null or omitted means root categories)
        - name: language
          in: query
          required: false
          schema:
            type: string
            default: "bo"
          description: Language code for localized category titles (defaults to "bo")
      responses:
        "200":
          description: Categories retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      description: Category ID
                    parent:
                      type: string
                      nullable: true
                      description: Parent category ID if exists
                    title:
                      type: string
                      description: Localized category title in requested language
                    has_child:
                      type: boolean
                      description: Whether this category has child categories
                      default: false
              examples:
                root_categories:
                  summary: Root categories in English
                  value:
                    - id: "CAT12345678"
                      parent: null
                      title: "Literature"
                      has_child: true
                    - id: "CAT23456789"
                      parent: null
                      title: "History"
                      has_child: false
                child_categories:
                  summary: Child categories in Tibetan
                  value:
                    - id: "CAT87654321"
                      parent: "CAT12345678"
                      title: "སྙན་ངག"
                      has_child: false
                    - id: "CAT98765432"
                      parent: "CAT12345678"
                      title: "གཏམ་རྒྱུད"
                      has_child: true
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "500":
          $ref: '#/components/responses/ServerError'
    post:
      summary: Create a new category
      description: Create a category with localized title and optional parent relationship
      tags:
        - Categories
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - application
                - title
              properties:
                application:
                  type: string
                  description: Application context for the category
                title:
                  type: object
                  additionalProperties:
                    type: string
                  description: Localized category titles
                parent:
                  type: string
                  nullable: true
                  description: Parent category ID (optional)
            examples:
              root_category:
                summary: Root category without parent
                value:
                  application: "webuddhist"
                  title:
                    en: "Literature"
                    bo: "རྩོམ་རིག"
                  parent: null
              child_category:
                summary: Child category with parent
                value:
                  application: "webuddhist"
                  title:
                    en: "Poetry"
                    bo: "སྙན་ངག"
                  parent: "CAT12345678"
      responses:
        "201":
          description: Category created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: Generated category ID
                  application:
                    type: string
                    description: Application context
                  title:
                    type: object
                    additionalProperties:
                      type: string
                    description: Localized titles
                  parent:
                    type: string
                    nullable: true
                    description: Parent category ID if provided
              examples:
                root_category:
                  summary: Created root category
                  value:
                    id: "CAT12345678"
                    application: "webuddhist"
                    title:
                      en: "Literature"
                      bo: "རྩོམ་རིག"
                    parent: null
                child_category:
                  summary: Created child category
                  value:
                    id: "CAT87654321"
                    application: "webuddhist"
                    title:
                      en: "Poetry"
                      bo: "སྙན་ངག"
                    parent: "CAT12345678"
        "400":
          $ref: '#/components/responses/InvalidRequest'
        "422":
          $ref: '#/components/responses/ValidationError'
        "500":
          $ref: '#/components/responses/ServerError'

  /api/version:
      get:
        summary: Get API version and Git SHA
        description: Returns the current API version and the Git commit SHA of the deployed code.
        operationId: getVersion
        tags:
            - API
        responses:
            "200":
              description: Successfully retrieved version information
              content:
                application/json:
                  schema:
                    type: object
                    properties:
                      version:
                          type: string
                          examples: 
                            - "0.1.0"
                      git_sha:
                          type: string
                          examples:
                            - "b706d2b1a5d0176df374da25c970274b2e0f7770"
            "500":
              $ref: '#/components/responses/ServerError'

components:
  responses:
    InvalidRequest:
      description: There was an error with the request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "There was an error with the request"
            required:
              - error
      
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "Resource was not found"
            required:
              - error
  
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: array
                items:
                  type: object
                  properties:
                    loc:
                      type: array
                      items:
                        type: string
                    msg:
                      type: string
                    type:
                      type: string
            required:
              - error
              - details
          examples:
            fieldMissing:
              value:
                error: "Validation error"
                details: [
                  {
                    "loc": ["body", "title"],
                    "msg": "field required", 
                    "type": "value_error.missing"
                  }
                ]

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                description: Error message
                examples:
                  - "There was an error on the server"
            required:
              - error
