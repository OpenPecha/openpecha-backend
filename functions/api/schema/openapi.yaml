openapi: '3.1.0'
info:
  title: OpenPecha API
  version: '0.1.0'
servers:
  - url: https://api-aq25662yyq-uc.a.run.app

paths:
  /pecha:
    post:
      summary: Create a Pecha
      description: Accepts a text document (.docx) and associated metadata in JSON format, processes them, and stores the resulting Pecha in the database.
      tags:
        - Pecha
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - text
                - metadata
              properties:
                text:
                  type: string
                  format: binary
                  description: The uploaded text file (must be .docx format).
                metadata:
                  type: string
                  format: json
                  description: JSON-encoded metadata describing the document. The structure follows [metadata schema](https://pecha-backend.web.app/schema/metadata).
      responses:
        "200":
          description: Successfully published the text document.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - Text published successfully
                  id:
                    type: string
                    description: The ID of the newly created Pecha.
                    examples: 
                      - I857977C3
                  title:
                    type: string
                    description: The title of the newly created Pecha, in the language of the text
                    examples:
                      - "Illuminating the Intent"
        "400":
          description: Bad request (e.g., invalid file format or missing metadata).
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - "Text file: Invalid file type. Supported types: .docx"
        "422":
          description: Unprocessable entity (e.g., invalid metadata format).
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: array
                    description: Detailed validation errors.
                    items:
                      properties:
                        message:
                          type: string
                          description: Validation error message.
                          examples: 
                            - "'author' is a required property"
                        path:
                          type: array
                          items:
                            type: string
                          description: The path to the field causing the validation error.
                          examples: 
                            - ["author"]
                        schema_path:
                          type: array
                          items:
                            type: string
                          description: The schema path related to the error.
                          examples: 
                            - ["properties", "author", "required"]
        "500":
          description: Internal server error (e.g., database failure).
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - Failed to save to DB
  /pecha/{pecha_id}:
    get:
      summary: Retrieve a Pecha OPF File
      description: Returns the OPF ZIP file for a given Pecha ID.
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha whose OPF file is requested.
      responses:
        "200":
          description: Successfully retrieved the OPF ZIP file.
          content:
            application/zip:
              schema:
                type: string
                format: binary
              examples:
                success:
                  summary: OPF ZIP File Download
                  description: The OPF ZIP file for a given Pecha ID.
                  value: (binary content of the ZIP file)
          headers:
            Content-Disposition:
              description: Suggests the filename for download.
              schema:
                type: string
              examples:
                attachment:
                  summary: File Attachment Header
                  description: Indicates the file should be downloaded.
                  value: "attachment; filename=I857977C3.zip"
        "404":
          description: Pecha not found.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        "500":
          description: Internal server error if retrieving the Pecha fails.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    delete:
      summary: Delete a Pecha
      description: Deletes a Pecha from the database.
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha to be deleted.
      responses:
        "200":
          description: Pecha deleted successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    examples:
                      - I857977C3
                  message:
                    type: string
                    examples:
                      - Pecha deleted successfully
        "404":
          description: Pecha not found.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - Pecha I857977C3 not found
        "500":
          description: Internal server error if deleting the Pecha fails.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - "Failed to delete pecha: Internal error"
  /pecha/{pecha_id}/publish:
    post:
      summary: Publish a Pecha to Pecha.org
      description: The Pecha referenced by the ID in the path will be serialized, and the result uploaded to Pecha.org
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha to be published.
      responses:
        "200":
          description: Pecha published successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - Pecha published successfully
                  id:
                    type: string
                    examples: 
                    - I857977C3
        "400":
          description: Bad request due to missing Pecha ID.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - Missing Pecha ID
        "500":
          description: Internal server error if publishing fails.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples: 
                      - "Failed to publish pecha: Internal error"
  /languages:
    get:
      summary: Retrieve the list of available languages
      description: Fetches all available languages from DB, returning an array where each item contains a language code and name.
      tags:
        - Other
      responses:
        "200":
          description: Successfully retrieved the list of languages.
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    code:
                      type: string
                      description: The ISO language code.
                      examples:
                        - bo
                    name:
                      type: string
                      description: The name of the language.
                      examples:
                        - Tibetan
        "500":
          description: Internal server error (e.g., database failure).
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
              examples:
                errorExample:
                  summary: Example error response
                  value:
                    {
                      "error": "Failed to retrieve languages from DB"
                    }
  /metadata/{pecha_id}:
    get:
      summary: Retrieve metadata by Pecha ID
      description: Fetch metadata associated with the given Pecha
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          description: The Pecha whose metadata is being requested.
          schema:
            type: string
      responses:
        "200":
          description: Metadata retrieved successfully
          content:
            application/json:
              schema:
                $ref: "https://pecha-backend.web.app/schema/metadata"
        "404":
          description: Metadata not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples: 
                      - Metadata not found
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples: 
                      - "Failed to retrieve metadata: {error details}"
    put:
      summary: Overwrite metadata by ID
      description: Overwrites metadata for a given Pecha ID in DB. The metadata must be valid.
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          description: The Pecha ID whose metadata is being updated.
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                metadata:
                  type: object
                  description: The updated metadata object.
              required:
                - metadata
      responses:
        "200":
          description: Metadata updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - Metadata updated successfully
                  id:
                    type: string
                    examples:
                      - I62E00D78
        "400":
          description: Bad request (missing metadata field)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples: 
                      - \'metadata\' field is required
        "404":
          description: Metadata not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - Metadata with ID \'I62E00D78\' not found
        "422":
          description: Metadata validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    description: Details of validation errors
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - "Failed to update metadata: {error details}"
  /metadata/filter:
    post:
      summary: Filter metadata
      description: |
        Filter metadata using **four possible modes**:
        
        1. **Single Field Query** - Search by a single metadata field.
        2. **AND Query** - Return results that match **all** given conditions.  
        3. **OR Query** - Return results that match **any** given conditions.
        4. **No Filters** - If the request body is empty, all Pechas are returned.  
      tags:
        - Pecha
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                filter:
                  $ref: "https://pecha-backend.web.app/schema/filter"
      responses:
        "200":
          description: Successfully retrieved filtered metadata
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      description: Unique Pecha ID.
                      examples: 
                        - I857977C3
                    title:
                      type: string
                      description: Title of the Pecha in its respective language.
                      examples:
                        - "Illuminating the Intent Chapter 6"
        "400":
          description: Invalid request or unsupported query format
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
  /schema/filter:
    get:
      summary: Retrieve the Filter Schema
      description: Returns the full JSON schema definition for filter validation.
      tags:
        - Schema
      responses:
        "200":
          description: Successfully retrieved the filter schema.
          content:
            application/json:
              schema:
                type: object
                description: The full JSON schema definition.
        "404":
          description: Schema file not found.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - "Schema not found"
  /schema/metadata:
    get:
      summary: Retrieve the Metadata Schema
      description: Returns the full JSON schema definition for metadata validation.
      tags:
        - Schema
      responses:
        "200":
          description: Successfully retrieved the metadata schema.
          content:
            application/json:
              schema:
                type: object
                description: The full JSON schema definition.
        "404":
          description: Schema file not found.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - "Schema not found"
  /api/version:
      get:
        summary: Get API version and Git SHA
        description: Returns the current API version and the Git commit SHA of the deployed code.
        operationId: getVersion
        tags:
            - API
        responses:
            "200":
              description: Successfully retrieved version information
              content:
                application/json:
                  schema:
                    type: object
                    properties:
                      version:
                          type: string
                          examples: 
                            - "0.1.0"
                      git_sha:
                          type: string
                          examples:
                            - "b706d2b1a5d0176df374da25c970274b2e0f7770"
  /text/{pecha_id}:
    put:
      summary: Upload a text to update a Pecha
      description: Uploads a docx file and updates the Pecha. The Pecha is re-parsed.
      operationId: putText
      tags:
        - Pecha
      parameters:
        - name: pecha_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the Pecha that is being updated.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                docx:
                  type: string
                  format: binary
                  description: The docx file containing the updated Pecha content.
            examples:
              valid_docx:
                summary: Valid docx file upload
                description: A valid docx file to update a Pecha.
                value:
                  docx: (binary content of a DOCX file)
      responses:
        "201":
          description: Successfully updated the Pecha.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    examples:
                      - Pecha updated successfully
                  id:
                    type: string
                    examples:
                      - I857977C3
        "400":
          description: Bad request due to missing or invalid DOCX file.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - "Missing required 'docx' parameter"
        "404":
          description: Pecha metadata not found.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - "Pecha metadata not found"
        "500":
          description: Internal server error if updating the Pecha fails.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    examples:
                      - "Failed to update Pecha: Internal error"